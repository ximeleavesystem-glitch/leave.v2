<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>XIME — Dean’s Dashboard</title>

  <style>
    :root{
      --red:#c1121f;
      --redDark:#9b0f19;
      --bg:#fbfbfc;
      --ink:#111827;
      --muted:#6b7280;
      --line:#e5e7eb;
      --soft:#f6f7f9;
      --card:#ffffff;
      --good:#0f766e;
      --bad:#b42318;
      --warn:#b54708;
      --shadow: 0 10px 24px rgba(17,24,39,.08);
      --radius: 16px;
      --font: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family:var(--font);
      color:var(--ink);
      background:
        radial-gradient(1000px 520px at 20% 0%, rgba(193,18,31,.08), transparent 55%),
        radial-gradient(900px 500px at 90% 10%, rgba(193,18,31,.06), transparent 55%),
        linear-gradient(180deg, #fff 0%, #fff 50%, var(--bg) 100%);
      min-height:100vh;
    }

    /* Topbar */
    .topbar{
      position:sticky; top:0; z-index:50;
      background: rgba(255,255,255,.86);
      backdrop-filter: blur(12px);
      border-bottom:1px solid var(--line);
    }
    .topbarInner{
      max-width:1200px; margin:auto; padding:12px 16px;
      display:flex; align-items:center; justify-content:space-between; gap:12px;
    }
    .brand{ display:flex; gap:12px; align-items:center; min-width:0; }
    .brand img{ width:96px; max-height:48px; object-fit:contain; display:block; }
    .brandText{ line-height:1.15; min-width:0; }
    .brandText .inst{
      font-size:14px; font-weight:850;
      white-space:nowrap; overflow:hidden; text-overflow:ellipsis; max-width:560px;
    }
    .brandText .sys{
      font-size:16px; font-weight:850; color:var(--red);
      white-space:nowrap; overflow:hidden; text-overflow:ellipsis; max-width:560px;
    }

    /* Buttons */
    .btn{
      padding:10px 14px; border:none; border-radius:12px;
      font-weight:800; cursor:pointer; color:#fff;
      background:linear-gradient(135deg,var(--red),#ff3b3b);
      box-shadow: 0 10px 20px rgba(193,18,31,.14);
      transition:.12s ease;
    }
    .btn:hover{ transform: translateY(-1px); }
    .btn:active{ transform: translateY(0px); opacity:.92; }

    .wrap{ max-width:1200px; margin:auto; padding:16px 16px 26px; }

    /* Tabs */
    .tabs{ display:flex; gap:10px; flex-wrap:wrap; margin-bottom:14px; }
    .tab{
      border:1px solid var(--line);
      background:#fff;
      padding:10px 12px;
      border-radius:999px;
      cursor:pointer;
      font-weight:800;
      font-size:13px;
      color:#111827;
      transition:.12s ease;
      min-width: 190px;
      text-align:center;
      user-select:none;
    }
    .tab:hover{ border-color: rgba(193,18,31,.35); transform: translateY(-1px); }
    .tab.active{
      border-color: rgba(193,18,31,.55);
      background: rgba(193,18,31,.06);
      color: var(--redDark);
      box-shadow: 0 10px 18px rgba(193,18,31,.08);
    }

    /* Panel */
    .panel{
      background:var(--card);
      border:1px solid var(--line);
      border-radius:var(--radius);
      box-shadow:var(--shadow);
      overflow:hidden;
    }
    .panelHead{
      padding:14px 16px;
      border-bottom:1px solid var(--line);
      display:flex; align-items:center; justify-content:space-between; gap:10px;
      background: linear-gradient(180deg, rgba(193,18,31,.05), rgba(255,255,255,.0));
    }
    .panelTitle{
      margin:0; font-size:15px; font-weight:850;
      display:flex; align-items:center; gap:10px;
    }
    .panelTitle .dot{
      width:10px; height:10px; border-radius:999px; background: var(--red);
      box-shadow: 0 0 0 6px rgba(193,18,31,.10);
    }
    .panelBody{ padding:14px 16px 16px; }
    .hidden{ display:none !important; }

    .sectionTitle{ margin: 10px 0 10px; display:flex; align-items:center; justify-content:space-between; gap:10px; }
    .sectionTitle h4{ margin:0; font-size:13px; font-weight:850; color: var(--redDark); }
    .sectionTitle .hint{ font-size:12px; color: var(--muted); font-weight:650; }

    /* Metrics */
    .metricsWrap{ display:grid; gap:14px; margin-top:6px; }
    .metrics{ display:grid; grid-template-columns: repeat(4, minmax(190px, 1fr)); gap:12px; }
    @media(max-width: 980px){ .metrics{ grid-template-columns: repeat(2, minmax(190px, 1fr)); } }
    @media(max-width: 520px){ .metrics{ grid-template-columns: 1fr; } }
    .metric{
      border:1px solid var(--line);
      background: #fff;
      border-radius:14px;
      padding:14px;
      box-shadow: 0 8px 18px rgba(17,24,39,.06);
    }
    .metric .k{ font-size:11px; color:var(--muted); font-weight:750; letter-spacing:.2px; }
    .metric .v{ margin-top:8px; font-size:28px; font-weight:900; }

    /* Pills */
    .pill{
      display:inline-flex; align-items:center; gap:8px;
      border-radius:999px; padding:6px 10px;
      font-size:12px; font-weight:800;
      border:1px solid var(--line); background:var(--soft);
      white-space:nowrap;
    }
    .pill.pending{ color: var(--warn); border-color: rgba(181,71,8,.25); background: rgba(181,71,8,.06); }
    .pill.approved{ color: var(--good); border-color: rgba(15,118,110,.25); background: rgba(15,118,110,.06); }
    .pill.rejected{ color: var(--bad); border-color: rgba(180,35,24,.22); background: rgba(180,35,24,.06); }
    .pill.locked{ color:#374151; border-color: rgba(55,65,81,.25); background: rgba(55,65,81,.06); }

    /* Filters */
    .filters{
      display:flex; flex-wrap:wrap; gap:10px;
      margin-bottom:12px; padding:10px;
      border:1px solid var(--line);
      border-radius:14px;
      background: rgba(193,18,31,.03);
      align-items:center;
    }
    .input, select{
      border:1px solid var(--line);
      border-radius:14px;
      padding:10px 12px;
      background:#fff;
      font-weight:750;
      font-size:13px;
      outline:none;
    }
    .input:focus, select:focus{
      border-color: rgba(193,18,31,.60);
      box-shadow: 0 0 0 4px rgba(193,18,31,.10);
    }
    .applyBtn{
      padding:10px 14px; border:none; border-radius:14px;
      font-weight:800; cursor:pointer; color:#fff;
      background: linear-gradient(135deg, var(--red), #ff3b3b);
      box-shadow: 0 10px 20px rgba(193,18,31,.12);
      transition:.12s ease;
    }
    .applyBtn:hover{ transform: translateY(-1px); }
    .clearBtn{
      padding:10px 14px;
      border:1px solid rgba(193,18,31,.35);
      border-radius:14px;
      font-weight:800;
      cursor:pointer;
      color:var(--redDark);
      background:#fff;
      box-shadow: 0 8px 18px rgba(17,24,39,.06);
      transition:.12s ease;
    }
    .clearBtn:hover{ transform: translateY(-1px); border-color: rgba(193,18,31,.55); }
    .qBtn{
      padding:10px 14px;
      border-radius:999px;
      border:1px solid var(--line);
      background:#fff;
      font-weight:950;
      cursor:pointer;
      box-shadow: 0 10px 20px rgba(17,24,39,.06);
      transition:.12s ease;
    }
    .qBtn:hover{ transform: translateY(-1px); border-color: rgba(193,18,31,.35); }
    .qBtn.active{ background: rgba(193,18,31,.08); border-color: rgba(193,18,31,.55); color: var(--redDark); }

    /* Request cards */
    .requestCard{
      background:#fff;
      border:1px solid var(--line);
      border-radius:16px;
      box-shadow:var(--shadow);
      padding:14px;
      margin-bottom:12px;
      overflow:hidden;
    }
    .cardTop{ display:flex; justify-content:space-between; align-items:flex-start; gap:10px; flex-wrap:wrap; }
    .studentBlock{ display:flex; gap:12px; align-items:center; min-width:0; }
    .studentAvatar{
      width:74px; height:96px; border-radius:16px;
      border:1px dashed rgba(193,18,31,.35);
      background: rgba(193,18,31,.05);
      display:grid; place-items:center;
      color:var(--redDark); font-weight:900; letter-spacing:.5px; text-transform:uppercase;
      overflow:hidden;
      flex: 0 0 auto;
    }
    .studentAvatar img{ width:100%; height:100%; object-fit:cover; display:block; }
    .studentText{ min-width:0; }
    .studentName{ font-size:18px; font-weight:900; }
    .studentMeta{ margin-top:4px; font-size:13px; color:var(--muted); font-weight:650; }
    .tagType{
      margin-top:6px;
      font-size:12px;
      font-weight:800;
      color: var(--redDark);
      display:inline-flex;
      gap:8px;
      align-items:center;
    }
    .tagType .miniDot{
      width:7px; height:7px; border-radius:999px; background: var(--red);
      box-shadow: 0 0 0 4px rgba(193,18,31,.10);
    }
    .details{ display:grid; grid-template-columns:1fr 1fr; gap:12px; margin-top:12px; }
    @media(max-width:700px){ .details{ grid-template-columns:1fr } }
    .kv{
      background:var(--soft);
      border-radius:14px;
      padding:12px;
      border:1px solid var(--line);
    }
    .kv .k{ font-size:11px; color:var(--muted); font-weight:750; letter-spacing:.2px; }
    .kv .v{ margin-top:6px; font-size:14px; font-weight:800; letter-spacing:.1px; }
    .reasonBox{ grid-column:1/-1; }
    textarea{
      width:100%;
      margin-top:10px;
      padding:12px;
      border-radius:14px;
      border:1px solid var(--line);
      font-family:var(--font);
      font-size:14px;
      resize:vertical;
      min-height:84px;
      outline:none;
    }
    textarea:focus{
      border-color: rgba(193,18,31,.60);
      box-shadow: 0 0 0 4px rgba(193,18,31,.10);
    }
    .actionsRow{ margin-top:12px; display:flex; gap:10px; flex-wrap:wrap; }
    .actionBtn{
      border:none;
      padding:11px 16px;
      border-radius:14px;
      font-weight:900;
      cursor:pointer;
      transition: .12s ease;
      box-shadow: 0 10px 20px rgba(17,24,39,.10);
    }
    .actionBtn:hover{ transform: translateY(-1px); }
    .actionBtn:active{ transform: translateY(0px); opacity:.92; }
    .actionBtn:disabled{
      cursor:not-allowed;
      opacity:.55;
      transform:none !important;
      box-shadow:none !important;
    }
    .approveBtn{ background: linear-gradient(135deg, var(--good), #14b8a6); color:#fff; }
    .rejectBtn{ background: linear-gradient(135deg, var(--bad), #ff3b3b); color:#fff; }

    .empty{
      padding:14px;
      color:var(--muted);
      font-weight:750;
      background: rgba(17,24,39,.02);
      border:1px dashed var(--line);
      border-radius:14px;
    }

    /* Reports (Download PDF) */
    .reportsShell{
      border:1px solid var(--line);
      border-radius:18px;
      background: linear-gradient(180deg, rgba(193,18,31,.04), rgba(255,255,255,.0));
      box-shadow: 0 12px 28px rgba(17,24,39,.06);
      overflow:hidden;
    }
    .reportsHead{
      display:flex; align-items:center; justify-content:space-between; gap:10px;
      padding:14px 16px;
      border-bottom:1px solid var(--line);
      background: rgba(255,255,255,.82);
    }
    .reportsTitle{ margin:0; font-size:18px; font-weight:950; }
    .reportsBody{ padding:14px 16px 16px; }
    .reportsHint{ color: var(--muted); font-weight:750; margin: 0 0 12px; }

    .modeTabs{ display:flex; gap:10px; flex-wrap:wrap; margin-bottom:12px; }
    .modeTab{
      border:1px solid var(--line);
      background:#fff;
      padding:10px 14px;
      border-radius:999px;
      font-weight:950;
      cursor:pointer;
      transition:.12s ease;
      user-select:none;
    }
    .modeTab:hover{ transform: translateY(-1px); border-color: rgba(193,18,31,.35); }
    .modeTab.active{ background: rgba(193,18,31,.08); border-color: rgba(193,18,31,.55); color: var(--redDark); }

    .reportGrid{
      display:grid;
      grid-template-columns: 1.2fr 1.2fr 1fr;
      gap:12px;
      align-items:end;
    }
    @media(max-width: 980px){ .reportGrid{ grid-template-columns: 1fr 1fr; } }
    @media(max-width: 560px){ .reportGrid{ grid-template-columns: 1fr; } }

    .rBox{ border:1px solid var(--line); border-radius:16px; padding:10px 12px; background:#fff; }
    .rBox label{ display:block; font-size:12px; color:var(--muted); font-weight:900; margin-bottom:6px; }

    .bigDownload{
      height:46px;
      border:none;
      border-radius:14px;
      width:100%;
      font-weight:950;
      cursor:pointer;
      color:#fff;
      background: linear-gradient(135deg, var(--red), var(--redDark));
      box-shadow: 0 14px 28px rgba(193,18,31,.20);
      transition:.12s ease;
    }
    .bigDownload:hover{ transform: translateY(-1px); box-shadow: 0 18px 36px rgba(193,18,31,.24); }
    .bigDownload:active{ transform: translateY(0px); opacity:.95; }
    .bigDownload:disabled{ cursor:not-allowed; opacity:.6; transform:none; box-shadow:none; }

    .toast{
      margin-top:12px;
      border:1px solid var(--line);
      border-radius:14px;
      padding:10px 12px;
      background:#fff;
      color:var(--muted);
      font-weight:800;
      display:none;
    }
    .toast.bad{ display:block; border-color: rgba(180,35,24,.25); background: rgba(180,35,24,.06); color: var(--bad); }
    .toast.good{ display:block; border-color: rgba(15,118,110,.25); background: rgba(15,118,110,.06); color: var(--good); }

    .rollRow{ margin-top:12px; display:none; }
    .rollRow.show{ display:block; }
  </style>
</head>

<body>
  <div class="topbar">
    <div class="topbarInner">
      <div class="brand">
        <img id="ximeLogo" src="../assets/img/xime-logo.jpg" alt="XIME Logo" />
        <div class="brandText">
          <div class="inst">Xavier Institute of Management and Entrepreneurship</div>
          <div class="sys">Dean’s Dashboard</div>
        </div>
      </div>
      <button class="btn" id="logoutBtn" type="button">Logout</button>
    </div>
  </div>

  <div class="wrap">
    <div class="tabs">
      <div class="tab active" id="tabDash">Dashboard</div>
      <div class="tab" id="tabEscalations">Escalations (Action Required)</div>
      <div class="tab" id="tabIntimations">Intimations (Approved Final)</div>
      <div class="tab" id="tabHistory">History (Dean Acted)</div>
    </div>

    <!-- DASHBOARD -->
    <section class="panel" id="pageDash">
      <div class="panelHead">
        <h3 class="panelTitle"><span class="dot"></span>Dashboard</h3>
      </div>
      <div class="panelBody">
        <div class="metricsWrap">
          <div class="filters" id="dashFilters">
            <input class="input" id="dFrom" type="date" title="From date" />
            <input class="input" id="dTo" type="date" title="To date" />
            <button class="applyBtn" id="applyDashBtn" type="button">Apply</button>
            <button class="clearBtn" id="clearDashBtn" type="button">Clear</button>
          </div>

          <div class="sectionTitle" style="margin-top:4px;">
            <h4>Dean Metrics</h4>
            <div class="hint">Date filtered (OUT datetime)</div>
          </div>

          <div class="metrics">
            <div class="metric">
              <div class="k">PENDING WITH DEAN</div>
              <div class="v" id="mDeanPending">0</div>
            </div>
            <div class="metric">
              <div class="k">APPROVED BY DEAN</div>
              <div class="v" id="mDeanApproved">0</div>
            </div>
            <div class="metric">
              <div class="k">REJECTED BY DEAN</div>
              <div class="v" id="mDeanRejected">0</div>
            </div>
            <div class="metric">
              <div class="k">INTIMATIONS (APPROVED FINAL)</div>
              <div class="v" id="mIntimations">0</div>
            </div>
          </div>

          <!-- REPORTS -->
          <div class="reportsShell" style="margin-top:6px;">
            <div class="reportsHead">
              <h3 class="reportsTitle">Reports (Download PDF)</h3>
              <button class="clearBtn" id="repClearBtn" type="button">Clear</button>
            </div>
            <div class="reportsBody">
              <p class="reportsHint">
                Reports are filtered by <b>IN datetime</b>. Latecomers report includes only:
                <b>arrival.verified = true</b> and <b>late_minutes &gt; 0</b>.
              </p>

              <div class="modeTabs">
                <div class="modeTab active" id="modeTimeframe">Timeframe (Approved Final + Dean Approved)</div>
                <div class="modeTab" id="modeStudent">Student-wise (Roll No + Timeframe)</div>
                <div class="modeTab" id="modeLate">Latecomers (Verified + Late)</div>
              </div>

              <div class="reportGrid">
                <div class="rBox">
                  <label>From Date (IN)</label>
                  <input class="input" id="repFrom" type="date" />
                </div>
                <div class="rBox">
                  <label>To Date (IN)</label>
                  <input class="input" id="repTo" type="date" />
                </div>
                <div class="rBox">
                  <label>Year</label>
                  <select id="repYear">
                    <option value="">All</option>
                    <option value="1">Year 1</option>
                    <option value="2">Year 2</option>
                  </select>
                </div>
              </div>

              <!-- Roll input ONLY in student mode -->
              <div class="rollRow" id="rollRow">
                <div class="rBox">
                  <label>Roll No (Required for Student-wise)</label>
                  <input class="input" id="repRoll" placeholder="Eg: C08080" autocomplete="off" />
                </div>
              </div>

              <button class="bigDownload" id="repDownloadBtn" type="button" style="margin-top:12px;">Download PDF</button>
              <div class="toast" id="repToast"></div>
            </div>
          </div>
          <!-- END REPORTS -->
        </div>
      </div>
    </section>

    <!-- ESCALATIONS (DEAN ACTION) -->
    <section class="panel hidden" id="pageEscalations">
      <div class="panelHead">
        <h3 class="panelTitle"><span class="dot"></span>Escalations — Action Required</h3>
      </div>
      <div class="panelBody">
        <div id="escalationsList"></div>
      </div>
    </section>

    <!-- INTIMATIONS (APPROVED FINAL, NO DEAN ACTION) -->
    <section class="panel hidden" id="pageIntimations">
      <div class="panelHead">
        <h3 class="panelTitle"><span class="dot"></span>Intimations — Approved Final (No Dean Action)</h3>
      </div>
      <div class="panelBody">
        <div class="filters">
          <input class="input" id="iSearch" placeholder="Search roll/name/email" />
          <select id="iYear">
            <option value="">Year (All)</option>
            <option value="1">Year 1</option>
            <option value="2">Year 2</option>
          </select>
          <select id="iHostel">
            <option value="">Hostel (All)</option>
            <option value="boys">Boys</option>
            <option value="girls">Girls</option>
            <option value="guest_house">Guest House</option>
          </select>
          <input class="input" id="iFrom" type="date" title="From date" />
          <input class="input" id="iTo" type="date" title="To date" />
          <button class="qBtn" id="iNotReturnedBtn" type="button" title="Arrival NOT verified even after IN time exceeded">Not Returned Yet</button>
          <button class="applyBtn" id="applyIntBtn" type="button">Apply</button>
          <button class="clearBtn" id="clearIntBtn" type="button">Clear</button>
        </div>
        <div id="intimationList"></div>
      </div>
    </section>

    <!-- HISTORY (DEAN ACTED ONLY) -->
    <section class="panel hidden" id="pageHistory">
      <div class="panelHead">
        <h3 class="panelTitle"><span class="dot"></span>History — Dean Acted</h3>
      </div>
      <div class="panelBody">
        <div class="filters">
          <input class="input" id="hSearch" placeholder="Search roll/name/email" />
          <select id="hStatus">
            <option value="">Status (All)</option>
            <option value="approved_dean_final">Approved</option>
            <option value="rejected_dean">Rejected</option>
          </select>
          <select id="hYear">
            <option value="">Year (All)</option>
            <option value="1">Year 1</option>
            <option value="2">Year 2</option>
          </select>
          <select id="hHostel">
            <option value="">Hostel (All)</option>
            <option value="boys">Boys</option>
            <option value="girls">Girls</option>
            <option value="guest_house">Guest House</option>
          </select>
          <input class="input" id="hFrom" type="date" title="From date" />
          <input class="input" id="hTo" type="date" title="To date" />
          <button class="qBtn" id="hNotReturnedBtn" type="button" title="Arrival NOT verified even after IN time exceeded">Not Returned Yet</button>
          <button class="applyBtn" id="applyHistBtn" type="button">Apply</button>
          <button class="clearBtn" id="clearHistBtn" type="button">Clear</button>
        </div>
        <div id="historyList"></div>
      </div>
    </section>
  </div>

  <!-- ✅ IMPORTANT: UMD builds (NO module imports) to avoid @babel/runtime error -->
  <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jspdf-autotable@3.8.2/dist/jspdf.plugin.autotable.min.js"></script>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
    import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js";
    import {
      getFirestore, collection, getDocs, query, where, limit,
      updateDoc, doc, serverTimestamp, getDoc, setDoc
    } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";

    // ✅ bfcache fix
    window.addEventListener("pageshow", (e) => { if (e.persisted) window.location.reload(); });

    // ✅ jsPDF from UMD global
    const { jsPDF } = window.jspdf || {};
    if (!jsPDF){ console.error("jsPDF not loaded. Check CDN access."); }

    const firebaseConfig = {
      apiKey: "AIzaSyDgoq2rMU5kiKcz_27-hjBzd8rxS8yQqdY",
      authDomain: "xime-leave-system-b25a4.firebaseapp.com",
      projectId: "xime-leave-system-b25a4",
      storageBucket: "xime-leave-system-b25a4.firebasestorage.app",
      messagingSenderId: "802112635142",
      appId: "1:802112635142:web:0fd0f5ad1ae3ef8eb4de87"
    };

    const DEAN_EMAIL = "deanacademicchennai@xime.org";

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    const logo = document.getElementById("ximeLogo");
    logo.addEventListener("error", () => {
      if (!logo.dataset.try2){
        logo.dataset.try2 = "1";
        logo.src = "../assets/img/xime-logo.jpg";
        return;
      }
      logo.style.display = "none";
    });

    const logoutBtn = document.getElementById("logoutBtn");

    // Tabs
    const tabDash = document.getElementById("tabDash");
    const tabEscalations = document.getElementById("tabEscalations");
    const tabIntimations = document.getElementById("tabIntimations");
    const tabHistory = document.getElementById("tabHistory");

    // Pages
    const pageDash = document.getElementById("pageDash");
    const pageEscalations = document.getElementById("pageEscalations");
    const pageIntimations = document.getElementById("pageIntimations");
    const pageHistory = document.getElementById("pageHistory");

    // Dashboard filters
    const dFrom = document.getElementById("dFrom");
    const dTo = document.getElementById("dTo");
    const applyDashBtn = document.getElementById("applyDashBtn");
    const clearDashBtn = document.getElementById("clearDashBtn");

    // Dashboard metrics
    const mDeanPending = document.getElementById("mDeanPending");
    const mDeanApproved = document.getElementById("mDeanApproved");
    const mDeanRejected = document.getElementById("mDeanRejected");
    const mIntimations = document.getElementById("mIntimations");

    // Lists
    const escalationsList = document.getElementById("escalationsList");
    const intimationList = document.getElementById("intimationList");
    const historyList = document.getElementById("historyList");

    // Intimation filters
    const iSearch = document.getElementById("iSearch");
    const iYear = document.getElementById("iYear");
    const iHostel = document.getElementById("iHostel");
    const iFrom = document.getElementById("iFrom");
    const iTo = document.getElementById("iTo");
    const iNotReturnedBtn = document.getElementById("iNotReturnedBtn");
    const applyIntBtn = document.getElementById("applyIntBtn");
    const clearIntBtn = document.getElementById("clearIntBtn");

    // History filters
    const hSearch = document.getElementById("hSearch");
    const hStatus = document.getElementById("hStatus");
    const hYear = document.getElementById("hYear");
    const hHostel = document.getElementById("hHostel");
    const hFrom = document.getElementById("hFrom");
    const hTo = document.getElementById("hTo");
    const hNotReturnedBtn = document.getElementById("hNotReturnedBtn");
    const applyHistBtn = document.getElementById("applyHistBtn");
    const clearHistBtn = document.getElementById("clearHistBtn");

    // Reports UI
    const modeTimeframe = document.getElementById("modeTimeframe");
    const modeStudent = document.getElementById("modeStudent");
    const modeLate = document.getElementById("modeLate");
    const repFrom = document.getElementById("repFrom");
    const repTo = document.getElementById("repTo");
    const repYear = document.getElementById("repYear");
    const repRoll = document.getElementById("repRoll");
    const rollRow = document.getElementById("rollRow");
    const repDownloadBtn = document.getElementById("repDownloadBtn");
    const repClearBtn = document.getElementById("repClearBtn");
    const repToast = document.getElementById("repToast");

    let reportMode = "timeframe";
    let intimationsNotReturnedOnly = false;
    let historyNotReturnedOnly = false;

    function normalizeEmail(v){ return String(v||"").trim().toLowerCase(); }
    function normalizeRollno(v){ return String(v||"").trim().toUpperCase(); }
    function isoNow(){ return new Date().toISOString(); }

    function showToast(type, msg){
      repToast.className = "toast " + (type || "");
      repToast.textContent = msg || "";
      repToast.style.display = msg ? "block" : "none";
    }

    function showPage(which){
      [tabDash, tabEscalations, tabIntimations, tabHistory].forEach(x => x.classList.remove("active"));
      [pageDash, pageEscalations, pageIntimations, pageHistory].forEach(x => x.classList.add("hidden"));

      if (which === "dash"){ tabDash.classList.add("active"); pageDash.classList.remove("hidden"); }
      if (which === "escalations"){ tabEscalations.classList.add("active"); pageEscalations.classList.remove("hidden"); }
      if (which === "intimations"){ tabIntimations.classList.add("active"); pageIntimations.classList.remove("hidden"); }
      if (which === "history"){ tabHistory.classList.add("active"); pageHistory.classList.remove("hidden"); }
    }

    tabDash.addEventListener("click", async () => { showPage("dash"); await loadDashboard(); });
    tabEscalations.addEventListener("click", async () => { showPage("escalations"); await loadEscalations(); });
    tabIntimations.addEventListener("click", async () => { showPage("intimations"); await loadIntimations(); });
    tabHistory.addEventListener("click", async () => { showPage("history"); await loadHistory(); });

    logoutBtn.addEventListener("click", async () => {
      try{ await signOut(auth); }catch(_){}
      window.location.replace("../index.html");
    });

    function parseISO(iso){
      const d = new Date(iso);
      return isNaN(d) ? null : d;
    }

    function inDateRangeISO(iso, fromStr, toStr){
      if (!fromStr && !toStr) return true;
      const d = parseISO(iso);
      if (!d) return false;

      if (fromStr){
        const f = new Date(fromStr + "T00:00:00");
        if (d < f) return false;
      }
      if (toStr){
        const t = new Date(toStr + "T23:59:59");
        if (d > t) return false;
      }
      return true;
    }

    function toISO(value){
      if (!value) return "";

      // Firestore Timestamp (has toDate)
      if (typeof value === "object" && typeof value.toDate === "function"){
        return value.toDate().toISOString();
      }

      // Firestore Timestamp (plain object {seconds, nanoseconds})
      if (typeof value === "object" && typeof value.seconds === "number"){
        return new Date(value.seconds * 1000).toISOString();
      }

      // JS Date
      if (value instanceof Date){
        return value.toISOString();
      }

      // String
      if (typeof value === "string"){
        const d = new Date(value);
        return isNaN(d) ? "" : d.toISOString();
      }

      return "";
    }

    function getOutDT(r){ return toISO(r.out_datetime || r.outDT || r.outDateTime || r.out_time || r.outTime || ""); }
    function getInDT(r){ return toISO(r.in_datetime || r.inDT || r.inDateTime || r.in_time || r.inTime || ""); }

    // ✅ NEW: lock logic
    function canActBeforeOut(r){
      const outISO = getOutDT(r);
      const outD = parseISO(outISO);
      if (!outD) return false;
      return Date.now() < outD.getTime();
    }

    function getArrivalVerified(r){
      const v = r?.arrival?.verified;
      return v === true || String(v).toLowerCase() === "true";
    }

    function getActualIn(r){
      return toISO((r.arrival && r.arrival.actual_in_time) ? r.arrival.actual_in_time : (r.arrival && r.arrival.actualInTime) ? r.arrival.actualInTime : "");
    }

    function getLateMinutes(r){
      const lm = r?.arrival?.late_minutes ?? r?.arrival?.lateMinutes ?? r?.late_minutes ?? r?.lateMinutes;
      if (lm === null || lm === undefined || lm === "") return null;
      const n = Number(lm);
      return Number.isFinite(n) ? n : null;
    }

    function fmtDT(anyValue){
      const iso = toISO(anyValue);
      if (!iso) return "-";
      const dt = new Date(iso);
      if (isNaN(dt)) return "-";

      const dd = String(dt.getDate()).padStart(2,"0");
      const mm = String(dt.getMonth()+1).padStart(2,"0");
      const yyyy = dt.getFullYear();

      let hh = dt.getHours();
      const min = String(dt.getMinutes()).padStart(2,"0");
      const ampm = hh >= 12 ? "PM" : "AM";
      hh = hh % 12; hh = hh ? hh : 12;
      const hh2 = String(hh).padStart(2,"0");
      return `${dd}/${mm}/${yyyy} ${hh2}:${min} ${ampm}`;
    }

    function initials(name){
      const n = String(name || "").trim();
      if (!n) return "ST";
      const parts = n.split(/\s+/).filter(Boolean);
      const a = parts[0]?.[0] || "S";
      const b = parts.length > 1 ? (parts[parts.length-1]?.[0] || "") : (parts[0]?.[1] || "");
      return (a + b).toUpperCase();
    }

    function statusPillFromStatus(status){
      const s = String(status||"").toLowerCase();
      if (s === "approved_dean_final") return `<span class="pill approved">APPROVED</span>`;
      if (s === "rejected_dean") return `<span class="pill rejected">REJECTED</span>`;
      if (s === "pending_dean") return `<span class="pill pending">PENDING</span>`;
      return `<span class="pill pending">${String(status||"PENDING").toUpperCase()}</span>`;
    }

    function matchesText(r, needle){
      if (!needle) return true;
      const n = needle.toLowerCase();
      const pool = [r.student_name, r.student_rollno, r.student_email]
        .map(x => String(x||"").toLowerCase())
        .join(" | ");
      return pool.includes(n);
    }
    function matchesYear(r, y){
      if (!y) return true;
      return String(r.student_year || "") === String(y);
    }
    function matchesHostel(r, h){
      if (!h) return true;
      return String(r.student_hostel || "").toLowerCase() === String(h).toLowerCase();
    }

    // ✅ Create/update public gatepass doc (so QR works without login)
    async function upsertPublicGatepass(requestId, r){
      const payload = {
        status: "approved",
        approved_public_at: isoNow(),

        student_name: r.student_name || r.student?.name || "",
        student_rollno: r.student_rollno || r.student?.rollno || "",
        student_room_no: r.student_room_no || r.student?.room || r.student?.roomNo || "",
        student_email: r.student_email || r.studentEmail || r.student?.email || "",
        student_uid: r.student_uid || r.studentUid || r.student?.uid || "",

        leave_type: r.leave_type || "extended",
        out_datetime: getOutDT(r) || "",
        in_datetime: getInDT(r) || "",

        reason: r.reason_text || r.reason || r.reasonText || "",
        contact_no: r.contact_no || r.phone || r.contact || "",
        photo_url: r.photo_url || r.photoUrl || r.student_photo_url || r.studentPhotoUrl || "",

        updatedAt: serverTimestamp(),
        updated_at: serverTimestamp()
      };
      await setDoc(doc(db, "gatepass_public", requestId), payload, { merge: true });
    }

    // ✅ NEW: revoke/disable public gatepass (if Dean rejects or flips to reject)
    async function revokePublicGatepass(requestId, note){
      const payload = {
        status: "revoked",
        revoked_at: isoNow(),
        revoked_note: String(note || "Dean rejected / decision changed").slice(0, 250),
        updatedAt: serverTimestamp(),
        updated_at: serverTimestamp()
      };
      await setDoc(doc(db, "gatepass_public", requestId), payload, { merge: true });
    }

    // ✅ Drive-photo resolver logic
    function extractDriveId(url){
      const u = String(url || "").trim();
      if (!u) return "";
      const m1 = u.match(/drive\.google\.com\/file\/d\/([^\/]+)\//i);
      if (m1 && m1[1]) return m1[1];
      const m2 = u.match(/[?&]id=([^&]+)/i);
      if (m2 && m2[1]) return m2[1];
      const m3 = u.match(/uc\?export=view&id=([^&]+)/i);
      if (m3 && m3[1]) return m3[1];
      return "";
    }

    function resolveDriveUrls(rawLink){
      const id = extractDriveId(rawLink);
      if (!id) return { primary: rawLink, fallback: "" };
      return {
        primary: `https://lh3.googleusercontent.com/d/${id}=w1000`,
        fallback: `https://drive.google.com/uc?export=view&id=${id}`
      };
    }

    function resolvePhotoURL(raw){
      const link = String(raw || "").trim();
      if (!link) return { primary:"", fallback:"" };
      if (link.includes("drive.google.com") || link.includes("googleusercontent.com")) return resolveDriveUrls(link);
      if (link.startsWith("http://") || link.startsWith("https://")) return { primary: link, fallback:"" };
      return { primary:"", fallback:"" };
    }

    function buildAvatarNode(studentName, photoRaw){
      const init = initials(studentName);
      const wrap = document.createElement("div");
      wrap.className = "studentAvatar";
      wrap.textContent = init;

      const { primary, fallback } = resolvePhotoURL(photoRaw);
      if (!primary) return wrap;

      const img = new Image();
      img.alt = "Student photo";
      img.referrerPolicy = "no-referrer";
      let triedFallback = false;

      img.onload = () => {
        wrap.textContent = "";
        wrap.appendChild(img);
      };

      img.onerror = () => {
        if (!triedFallback && fallback){
          triedFallback = true;
          img.src = fallback;
          return;
        }
        wrap.textContent = init;
      };

      img.src = primary;
      return wrap;
    }

    function getApprovedBy(r){
      const direct =
        r.approved_by || r.approvedBy ||
        r.final_approved_by || r.finalApprovedBy ||
        r.current_approved_by || r.currentApprovedBy;

      if (direct) return String(direct);

      const chain = Array.isArray(r.approver_chain) ? r.approver_chain : [];
      for (let i = chain.length - 1; i >= 0; i--){
        const x = chain[i] || {};
        const act = String(x.action || x.status || "").toLowerCase();
        if (act === "approved" || act === "approve"){
          if (x.email) return String(x.email);
          if (x.approver_email) return String(x.approver_email);
          if (x.user_email) return String(x.user_email);
        }
      }
      return "";
    }

    /* ---------------- Dashboard ---------------- */
    async function loadDashboard(){
      const from = dFrom.value;
      const to = dTo.value;

      const qPending = query(collection(db, "leave_requests"), where("status","==","pending_dean"), limit(5000));
      const qDeanApproved = query(collection(db, "leave_requests"), where("status","==","approved_dean_final"), limit(5000));
      const qDeanRejected = query(collection(db, "leave_requests"), where("status","==","rejected_dean"), limit(5000));
      const qIntimations = query(collection(db, "leave_requests"), where("status","==","approved_final"), limit(5000));

      const [sp, sa, sr, si] = await Promise.all([ getDocs(qPending), getDocs(qDeanApproved), getDocs(qDeanRejected), getDocs(qIntimations) ]);

      const countByOutRange = (docsSnap) =>
        docsSnap.docs.map(d => d.data()).filter(x => inDateRangeISO(getOutDT(x), from, to)).length;

      const pendingRows = sp.docs.map(d => d.data()).filter(r => {
        const holder = normalizeEmail(r.current?.holder_email || r.current_holder_email || "");
        return holder ? holder === normalizeEmail(DEAN_EMAIL) : true;
      });

      const intimRows = si.docs.map(d => d.data()).filter(r => {
        const requested = !!(r.escalation && r.escalation.requested);
        const deanAction = String(r.escalation?.dean_action || "").toLowerCase();
        return !requested && (deanAction === "not_required" || deanAction === "" || deanAction === "na");
      });

      mDeanPending.textContent = pendingRows.filter(x => inDateRangeISO(getOutDT(x), from, to)).length;
      mDeanApproved.textContent = countByOutRange(sa);
      mDeanRejected.textContent = countByOutRange(sr);
      mIntimations.textContent = intimRows.filter(x => inDateRangeISO(getOutDT(x), from, to)).length;
    }

    applyDashBtn.addEventListener("click", loadDashboard);
    clearDashBtn.addEventListener("click", async () => {
      dFrom.value = "";
      dTo.value = "";
      await loadDashboard();
    });

    /* ---------------- Cards ---------------- */
    function baseStudentInfo(r){
      const studentName = r.student_name || r.student?.name || "—";
      const roll = r.student_rollno || r.student?.rollno || "—";
      const email = r.student_email || r.student?.email || "—";
      const room = r.student_room_no || r.student?.room || r.student?.roomNo || "—";

      const reason = r.reason_text || r.reason || r.reasonText || r.leave_reason || r.leaveReason || "-";

      const outVal = getOutDT(r) || "";
      const inVal = getInDT(r) || "";

      const photo =
        r.student_photo_url || r.studentPhotoUrl ||
        r.photo_url || r.photoUrl ||
        r.student?.photo_url || r.student?.photoUrl || "";

      return { studentName, roll, email, room, reason, outVal, inVal, photo };
    }

    function renderEscalationCard(r){
      const card = document.createElement("section");
      card.className = "requestCard";

      const { studentName, roll, email, room, reason, outVal, inVal, photo } = baseStudentInfo(r);
      const remarkId = `remark_${r.id}`;

      const top = document.createElement("div");
      top.className = "cardTop";

      const studentBlock = document.createElement("div");
      studentBlock.className = "studentBlock";
      studentBlock.appendChild(buildAvatarNode(studentName, photo));

      const text = document.createElement("div");
      text.className = "studentText";

      const escBy = r.escalation?.requested_by || "";
      const escReason = r.escalation?.reason || "";

      const locked = !canActBeforeOut(r);

      text.innerHTML = `
        <div class="studentName">${studentName}</div>
        <div class="studentMeta">${roll} • ${email} • Room ${room}</div>
        <div class="tagType"><span class="miniDot"></span>Escalated Request (Dean Action)</div>
        <div class="studentMeta" style="margin-top:6px;">
          <b>Escalated By:</b> ${escBy || "—"} &nbsp; • &nbsp; <b>Escalation Reason:</b> ${escReason || "—"}
        </div>
        <div class="studentMeta" style="margin-top:6px;">
          ${locked
            ? `<span class="pill locked">LOCKED (Out time passed)</span>`
            : `<span class="pill pending">EDITABLE until OUT time</span>`
          }
        </div>
      `;

      studentBlock.appendChild(text);
      top.appendChild(studentBlock);

      const pill = document.createElement("div");
      pill.innerHTML = `<span class="pill pending">PENDING</span>`;
      top.appendChild(pill);

      card.appendChild(top);

      const details = document.createElement("div");
      details.className = "details";
      details.innerHTML = `
        <div class="kv"><div class="k">OUT DATE & TIME</div><div class="v">${fmtDT(outVal)}</div></div>
        <div class="kv"><div class="k">IN DATE & TIME</div><div class="v">${fmtDT(inVal)}</div></div>
        <div class="kv reasonBox"><div class="k">LEAVE REASON</div><div class="v">${reason}</div></div>
      `;
      card.appendChild(details);

      const ta = document.createElement("textarea");
      ta.id = remarkId;
      ta.placeholder = "Dean Remark (optional)";
      ta.disabled = locked;
      card.appendChild(ta);

      const actions = document.createElement("div");
      actions.className = "actionsRow";

      const approve = document.createElement("button");
      approve.className = "actionBtn approveBtn";
      approve.type = "button";
      approve.textContent = "Approve";
      approve.disabled = locked;
      approve.addEventListener("click", () => deanApprove(r.id));

      const reject = document.createElement("button");
      reject.className = "actionBtn rejectBtn";
      reject.type = "button";
      reject.textContent = "Reject";
      reject.disabled = locked;
      reject.addEventListener("click", () => deanReject(r.id));

      actions.appendChild(approve);
      actions.appendChild(reject);
      card.appendChild(actions);

      return card;
    }

    function renderIntimationCard(r){
      const card = document.createElement("section");
      card.className = "requestCard";

      const { studentName, roll, email, room, reason, outVal, inVal, photo } = baseStudentInfo(r);

      const lt = String(r.leave_type || "").toLowerCase();
      const tag = lt ? lt.toUpperCase() : "APPROVED FINAL";

      const verified = getArrivalVerified(r);
      const actual = getActualIn(r);
      const lateMin = getLateMinutes(r);

      const approvedBy = getApprovedBy(r);

      const lateTxt = (verified && lateMin !== null)
        ? (lateMin > 0
            ? `<b style="color:var(--bad)">Late:</b> ${lateMin} min`
            : `<b style="color:var(--good)">On Time</b>`)
        : `<b style="color:var(--warn)">Arrival:</b> Not verified`;

      card.innerHTML = `
        <div class="cardTop">
          <div class="studentBlock">
            <div class="studentText">
              <div class="studentName">${studentName}</div>
              <div class="studentMeta">${roll} • ${email} • Room ${room}</div>
              <div class="tagType"><span class="miniDot"></span>Intimation (${tag})</div>

              <div class="studentMeta" style="margin-top:6px;">
                ${approvedBy ? `<b>Approved by:</b> ${approvedBy} &nbsp; • &nbsp; ` : ""}
                ${lateTxt}
                ${verified && actual ? ` &nbsp; • &nbsp; <b>Actual In:</b> ${fmtDT(actual)}` : ``}
              </div>
            </div>
          </div>
          <span class="pill approved">APPROVED</span>
        </div>

        <div class="details">
          <div class="kv"><div class="k">OUT DATE & TIME</div><div class="v">${fmtDT(outVal)}</div></div>
          <div class="kv"><div class="k">IN DATE & TIME</div><div class="v">${fmtDT(inVal)}</div></div>
          <div class="kv reasonBox"><div class="k">LEAVE REASON</div><div class="v">${reason}</div></div>
        </div>
      `;

      const sb = card.querySelector(".studentBlock");
      sb.prepend(buildAvatarNode(studentName, photo));
      return card;
    }

    function renderHistoryCard(r){
      const card = document.createElement("section");
      card.className = "requestCard";

      const { studentName, roll, email, room, reason, outVal, inVal, photo } = baseStudentInfo(r);

      const verified = getArrivalVerified(r);
      const actual = getActualIn(r);
      const lateMin = getLateMinutes(r);

      const lateTxt = (verified && lateMin !== null)
        ? (lateMin > 0
            ? `<b style="color:var(--bad)">Late:</b> ${lateMin} min`
            : `<b style="color:var(--good)">On Time</b>`)
        : `<b style="color:var(--warn)">Arrival:</b> Not verified`;

      const status = String(r.status || "").toLowerCase();
      const editable = canActBeforeOut(r);

      const editPill = editable
        ? `<span class="pill pending">EDITABLE until OUT time</span>`
        : `<span class="pill locked">LOCKED (Out time passed)</span>`;

      card.innerHTML = `
        <div class="cardTop">
          <div class="studentBlock">
            <div class="studentText">
              <div class="studentName">${studentName}</div>
              <div class="studentMeta">${roll} • ${email} • Room ${room}</div>
              <div class="tagType"><span class="miniDot"></span>Dean Acted</div>
              <div class="studentMeta" style="margin-top:6px;">
                ${lateTxt}
                ${verified && actual ? ` &nbsp; • &nbsp; <b>Actual In:</b> ${fmtDT(actual)}` : ``}
              </div>
              <div class="studentMeta" style="margin-top:6px;">
                ${editPill}
              </div>
            </div>
          </div>
          ${statusPillFromStatus(status)}
        </div>

        <div class="details">
          <div class="kv"><div class="k">OUT DATE & TIME</div><div class="v">${fmtDT(outVal)}</div></div>
          <div class="kv"><div class="k">IN DATE & TIME</div><div class="v">${fmtDT(inVal)}</div></div>
          <div class="kv reasonBox"><div class="k">LEAVE REASON</div><div class="v">${reason}</div></div>
        </div>
      `;

      const sb = card.querySelector(".studentBlock");
      sb.prepend(buildAvatarNode(studentName, photo));

      // ✅ NEW: Change-decision buttons (only before OUT time)
      if (status === "approved_dean_final" || status === "rejected_dean"){
        const actions = document.createElement("div");
        actions.className = "actionsRow";

        const btnApprove = document.createElement("button");
        btnApprove.className = "actionBtn approveBtn";
        btnApprove.type = "button";
        btnApprove.textContent = (status === "approved_dean_final") ? "Already Approved" : "Change to Approved";
        btnApprove.disabled = !editable || (status === "approved_dean_final");
        btnApprove.addEventListener("click", () => deanChangeDecision(r.id, "approved_dean_final"));

        const btnReject = document.createElement("button");
        btnReject.className = "actionBtn rejectBtn";
        btnReject.type = "button";
        btnReject.textContent = (status === "rejected_dean") ? "Already Rejected" : "Change to Rejected";
        btnReject.disabled = !editable || (status === "rejected_dean");
        btnReject.addEventListener("click", () => deanChangeDecision(r.id, "rejected_dean"));

        actions.appendChild(btnApprove);
        actions.appendChild(btnReject);
        card.appendChild(actions);
      }

      return card;
    }

    /* ---------------- Load lists ---------------- */
    async function loadEscalations(){
      escalationsList.innerHTML = "";
      const q1 = query(collection(db, "leave_requests"), where("status", "==", "pending_dean"), limit(5000));
      const snap = await getDocs(q1);
      const rows = snap.docs.map(d => ({ id: d.id, ...d.data() }));

      const deanRows = rows.filter(r => {
        const holder = normalizeEmail(r.current?.holder_email || r.current_holder_email || "");
        return !holder || holder === normalizeEmail(DEAN_EMAIL);
      });

      deanRows.sort((a,b) => String(getOutDT(b)||"").localeCompare(String(getOutDT(a)||"")));

      if (!deanRows.length){
        escalationsList.innerHTML = `<div class="empty">No escalations pending with Dean.</div>`;
        return;
      }

      const frag = document.createDocumentFragment();
      for (const r of deanRows) frag.appendChild(renderEscalationCard(r));
      escalationsList.appendChild(frag);
    }

    async function loadIntimations(){
      intimationList.innerHTML = "";
      const q1 = query(collection(db, "leave_requests"), where("status", "==", "approved_final"), limit(5000));
      const snap = await getDocs(q1);
      let rows = snap.docs.map(d => ({ id: d.id, ...d.data() }));

      rows = rows.filter(r => {
        const requested = !!(r.escalation && r.escalation.requested);
        const deanAction = String(r.escalation?.dean_action || "").toLowerCase();
        return !requested && (deanAction === "not_required" || deanAction === "" || deanAction === "na");
      });

      const s = (iSearch.value||"").trim();
      const y = iYear.value;
      const h = iHostel.value;
      const from = iFrom.value;
      const to = iTo.value;

      rows = rows.filter(r =>
        matchesText(r, s) &&
        matchesYear(r, y) &&
        matchesHostel(r, h) &&
        inDateRangeISO(getOutDT(r), from, to)
      );

      if (intimationsNotReturnedOnly){
        const now = Date.now();
        rows = rows.filter(r => {
          if (getArrivalVerified(r)) return false;
          const inD = parseISO(getInDT(r));
          if (!inD) return false;
          return now > inD.getTime();
        });
      }

      rows.sort((a,b) => String(getOutDT(b)||"").localeCompare(String(getOutDT(a)||"")));

      if (!rows.length){
        intimationList.innerHTML = `<div class="empty">No matching intimations.</div>`;
        return;
      }

      const frag = document.createDocumentFragment();
      for (const r of rows) frag.appendChild(renderIntimationCard(r));
      intimationList.appendChild(frag);
    }

    async function loadHistory(){
      historyList.innerHTML = "";

      const qA = query(collection(db, "leave_requests"), where("status","==","approved_dean_final"), limit(5000));
      const qR = query(collection(db, "leave_requests"), where("status","==","rejected_dean"), limit(5000));

      const [aS, rS] = await Promise.all([getDocs(qA), getDocs(qR)]);
      let rows = [
        ...aS.docs.map(d => ({ id:d.id, ...d.data() })),
        ...rS.docs.map(d => ({ id:d.id, ...d.data() }))
      ];

      const s = (hSearch.value||"").trim();
      const st = hStatus.value;
      const y = hYear.value;
      const h = hHostel.value;
      const from = hFrom.value;
      const to = hTo.value;

      rows = rows.filter(r =>
        matchesText(r, s) &&
        (st ? String(r.status||"") === st : true) &&
        matchesYear(r, y) &&
        matchesHostel(r, h) &&
        inDateRangeISO(getOutDT(r), from, to)
      );

      if (historyNotReturnedOnly){
        const now = Date.now();
        rows = rows.filter(r => {
          if (getArrivalVerified(r)) return false;
          const inD = parseISO(getInDT(r));
          if (!inD) return false;
          return now > inD.getTime();
        });
      }

      rows.sort((a,b) => {
        const ta = a.dean_acted_at || a.final_approved_at || a.final_rejected_at || a.updated_at || getOutDT(a) || "";
        const tb = b.dean_acted_at || b.final_approved_at || b.final_rejected_at || b.updated_at || getOutDT(b) || "";
        return String(tb).localeCompare(String(ta));
      });

      if (!rows.length){
        historyList.innerHTML = `<div class="empty">No matching Dean history.</div>`;
        return;
      }

      const frag = document.createDocumentFragment();
      for (const r of rows) frag.appendChild(renderHistoryCard(r));
      historyList.appendChild(frag);
    }

    applyIntBtn.addEventListener("click", loadIntimations);
    applyHistBtn.addEventListener("click", loadHistory);

    iNotReturnedBtn.addEventListener("click", async () => {
      intimationsNotReturnedOnly = !intimationsNotReturnedOnly;
      iNotReturnedBtn.classList.toggle("active", intimationsNotReturnedOnly);
      await loadIntimations();
    });

    hNotReturnedBtn.addEventListener("click", async () => {
      historyNotReturnedOnly = !historyNotReturnedOnly;
      hNotReturnedBtn.classList.toggle("active", historyNotReturnedOnly);
      await loadHistory();
    });

    clearIntBtn.addEventListener("click", async () => {
      iSearch.value = ""; iYear.value = ""; iHostel.value = "";
      iFrom.value = ""; iTo.value = "";
      intimationsNotReturnedOnly = false;
      iNotReturnedBtn.classList.remove("active");
      await loadIntimations();
    });

    clearHistBtn.addEventListener("click", async () => {
      hSearch.value = ""; hStatus.value = ""; hYear.value = ""; hHostel.value = "";
      hFrom.value = ""; hTo.value = "";
      historyNotReturnedOnly = false;
      hNotReturnedBtn.classList.remove("active");
      await loadHistory();
    });

    /* ---------------- Dean Approve/Reject ---------------- */
    function updateDeanChain(chain, remark, action){
      const list = Array.isArray(chain) ? [...chain] : [];
      const idx = list.findIndex(x => normalizeEmail(x?.email) === normalizeEmail(DEAN_EMAIL));
      if (idx < 0) return { ok:false, list };

      const nowISO = isoNow();
      list[idx] = {
        ...list[idx],
        action: action,
        status: action,
        remark: remark || "",
        acted_at: nowISO,
        actedAt: nowISO,
        acted_on: nowISO
      };
      return { ok:true, list };
    }

    async function deanApprove(id){
      const remark = (document.getElementById(`remark_${id}`)?.value || "").trim();
      const ref = doc(db, "leave_requests", id);
      const snap = await getDoc(ref);
      if (!snap.exists()) return;

      const r = snap.data();

      if (String(r.status||"").toLowerCase() !== "pending_dean"){
        alert("This request is not pending with Dean.");
        return;
      }

      // ✅ Lock check (must be before OUT time)
      if (!canActBeforeOut(r)){
        alert("Out time already reached. Dean action is locked for this request.");
        return;
      }

      const { ok, list } = updateDeanChain(r.approver_chain, remark, "approved");
      if (!ok){
        alert("Dean stage not found in approver_chain.");
        return;
      }

      const updates = {
        approver_chain: list,
        status: "approved_dean_final",

        escalation: { ...(r.escalation || {}), requested: true, dean_action: "approved", dean_acted_at: isoNow() },

        current_holder_email: null,
        current: { ...(r.current || {}), holder_email: null, holder_role: null, stage: null },

        final_approved_by: normalizeEmail(DEAN_EMAIL),
        final_approved_at: isoNow(),

        final_rejected_by: null,
        final_rejected_at: null,

        dean_acted_by: normalizeEmail(DEAN_EMAIL),
        dean_acted_at: isoNow(),

        updated_at: serverTimestamp(),
        updatedAt: serverTimestamp()
      };

      try{
        await updateDoc(ref, updates);
        await upsertPublicGatepass(id, { ...r, ...updates });

        await loadDashboard();
        await loadEscalations();
        await loadHistory();
      }catch(e){
        console.error(e);
        alert("Unable to approve. Check Firestore rules / indexes.");
      }
    }

    async function deanReject(id){
      const remark = (document.getElementById(`remark_${id}`)?.value || "").trim();
      const ref = doc(db, "leave_requests", id);
      const snap = await getDoc(ref);
      if (!snap.exists()) return;

      const r = snap.data();

      if (String(r.status||"").toLowerCase() !== "pending_dean"){
        alert("This request is not pending with Dean.");
        return;
      }

      // ✅ Lock check (must be before OUT time)
      if (!canActBeforeOut(r)){
        alert("Out time already reached. Dean action is locked for this request.");
        return;
      }

      const { ok, list } = updateDeanChain(r.approver_chain, remark, "rejected");
      if (!ok){
        alert("Dean stage not found in approver_chain.");
        return;
      }

      const updates = {
        approver_chain: list,
        status: "rejected_dean",

        escalation: { ...(r.escalation || {}), requested: true, dean_action: "rejected", dean_acted_at: isoNow() },

        current_holder_email: null,
        current: { ...(r.current || {}), holder_email: null, holder_role: null, stage: null },

        final_rejected_by: normalizeEmail(DEAN_EMAIL),
        final_rejected_at: isoNow(),

        dean_acted_by: normalizeEmail(DEAN_EMAIL),
        dean_acted_at: isoNow(),

        updated_at: serverTimestamp(),
        updatedAt: serverTimestamp()
      };

      try{
        await updateDoc(ref, updates);
        await revokePublicGatepass(id, remark || "Dean rejected");

        await loadDashboard();
        await loadEscalations();
        await loadHistory();
      }catch(e){
        console.error(e);
        alert("Unable to reject. Check Firestore rules / indexes.");
      }
    }

    // ✅ NEW: Change decision in History before OUT time
    async function deanChangeDecision(id, targetStatus){
      const ref = doc(db, "leave_requests", id);
      const snap = await getDoc(ref);
      if (!snap.exists()) return;

      const r = snap.data();
      const cur = String(r.status || "").toLowerCase();
      const target = String(targetStatus || "").toLowerCase();

      if (!(cur === "approved_dean_final" || cur === "rejected_dean")){
        alert("Only Dean-acted requests can be changed here.");
        return;
      }

      // ✅ Lock check
      if (!canActBeforeOut(r)){
        alert("Out time already reached. Decision change is locked.");
        return;
      }

      if (cur === target){
        alert("This request is already in that status.");
        return;
      }

      const remark = (prompt("Dean remark for decision change (optional):") || "").trim();

      const action = (target === "approved_dean_final") ? "approved" : "rejected";
      const { ok, list } = updateDeanChain(r.approver_chain, remark, action);
      if (!ok){
        alert("Dean stage not found in approver_chain.");
        return;
      }

      const nowISO = isoNow();

      const updates = {
        approver_chain: list,
        status: target,

        escalation: { ...(r.escalation || {}), requested: true, dean_action: action, dean_acted_at: nowISO },

        current_holder_email: null,
        current: { ...(r.current || {}), holder_email: null, holder_role: null, stage: null },

        dean_acted_by: normalizeEmail(DEAN_EMAIL),
        dean_acted_at: nowISO,

        updated_at: serverTimestamp(),
        updatedAt: serverTimestamp()
      };

      if (target === "approved_dean_final"){
        updates.final_approved_by = normalizeEmail(DEAN_EMAIL);
        updates.final_approved_at = nowISO;
        updates.final_rejected_by = null;
        updates.final_rejected_at = null;
      } else {
        updates.final_rejected_by = normalizeEmail(DEAN_EMAIL);
        updates.final_rejected_at = nowISO;
      }

      try{
        await updateDoc(ref, updates);

        if (target === "approved_dean_final"){
          await upsertPublicGatepass(id, { ...r, ...updates });
        } else {
          await revokePublicGatepass(id, remark || "Dean changed to rejected");
        }

        await loadDashboard();
        await loadEscalations();
        await loadHistory();
      }catch(e){
        console.error(e);
        alert("Unable to change decision. Check Firestore rules / indexes.");
      }
    }

    /* ---------------- Reports ---------------- */
    function setMode(m){
      reportMode = m;
      modeTimeframe.classList.toggle("active", m==="timeframe");
      modeStudent.classList.toggle("active", m==="student");
      modeLate.classList.toggle("active", m==="late");

      rollRow.classList.toggle("show", m==="student");
      if (m !== "student") repRoll.value = "";
    }

    modeTimeframe.addEventListener("click", () => setMode("timeframe"));
    modeStudent.addEventListener("click", () => setMode("student"));
    modeLate.addEventListener("click", () => setMode("late"));

    repClearBtn.addEventListener("click", () => {
      repFrom.value = "";
      repTo.value = "";
      repYear.value = "";
      repRoll.value = "";
      setMode("timeframe");
      showToast("", "");
    });

    async function fetchRowsForReport(){
      const from = repFrom.value || "";
      const to = repTo.value || "";
      const year = repYear.value || "";
      const rollNeedle = normalizeRollno(repRoll.value || "");

      if (reportMode === "student" && !rollNeedle){
        throw new Error("Enter Roll No for Student-wise report.");
      }

      const [sFinal, sDeanApproved] = await Promise.all([
        getDocs(query(collection(db, "leave_requests"), where("status","==","approved_final"), limit(5000))),
        getDocs(query(collection(db, "leave_requests"), where("status","==","approved_dean_final"), limit(5000)))
      ]);

      let rows = [
        ...sFinal.docs.map(d => ({ id:d.id, ...d.data() })),
        ...sDeanApproved.docs.map(d => ({ id:d.id, ...d.data() }))
      ];

      rows = rows.filter(r => inDateRangeISO(getInDT(r), from, to));

      if (year){
        rows = rows.filter(r => String(r.student_year || "") === String(year));
      }

      if (reportMode === "student"){
        rows = rows.filter(r => normalizeRollno(r.student_rollno || r.student?.rollno || "") === rollNeedle);
      }

      if (reportMode === "late"){
        rows = rows.filter(r => {
          if (!getArrivalVerified(r)) return false;
          const lm = getLateMinutes(r);
          return (lm !== null && lm > 0);
        });
      }

      rows.sort((a,b) => String(getInDT(a)||"").localeCompare(String(getInDT(b)||"")));
      return rows;
    }

    function makePDF(rows, meta){
      const docp = new jsPDF({ unit:"pt", format:"a4" });
      const left = 40;
      let y = 48;

      docp.setFont("helvetica","bold");
      docp.setFontSize(16);
      docp.text("Xavier Institute of Management and Entrepreneurship (XIME)", left, y);
      y += 22;

      docp.setTextColor(193,18,31);
      docp.setFontSize(14);
      docp.text(meta.title || "Leave Management System — Report", left, y);
      docp.setTextColor(0,0,0);

      y += 10;
      docp.setDrawColor(193,18,31);
      docp.setLineWidth(2);
      docp.line(left, y, 555, y);
      y += 22;

      docp.setFont("helvetica","normal");
      docp.setFontSize(11);

      const line = (label, value) => {
        docp.setFont("helvetica","normal");
        docp.text(`${label}:`, left, y);
        docp.setFont("helvetica","bold");
        docp.text(String(value || "—"), left + 140, y);
        y += 16;
      };

      line("Prepared by", `Dean (${DEAN_EMAIL})`);
      line("Generated", new Date().toLocaleString());
      line("IN datetime range", `${meta.from || "—"} to ${meta.to || "—"}`);
      line("Year Filter", meta.yearLabel || "All Years");
      line("Mode", meta.modeLabel || "Timeframe");
      if (meta.mode === "student") line("Roll No", meta.roll);

      y += 6;
      docp.setFont("helvetica","bold");
      docp.setFontSize(12);
      docp.text(`Total Records: ${rows.length}`, left, y);
      y += 14;

      docp.setDrawColor(193,18,31);
      docp.setLineWidth(2);
      docp.line(left, y, 555, y);
      y += 16;

      const body = rows.map((r, idx) => {
        const roll = r.student_rollno || r.student?.rollno || "";
        const nm = r.student_name || r.student?.name || "";
        const year = r.student_year || "";
        const hostel = r.student_hostel || "";
        const room = r.student_room_no || r.student?.room || r.student?.roomNo || "";
        const outDT = fmtDT(getOutDT(r));
        const inDT = fmtDT(getInDT(r));
        const lt = String(r.leave_type || "");
        const phone = r.contact_no || r.phone || r.contact || "";
        const reason = r.reason_text || r.reason || r.reasonText || "";
        const verified = getArrivalVerified(r) ? "YES" : "NO";
        const actualIn = getActualIn(r) ? fmtDT(getActualIn(r)) : "-";
        const lateMin = getLateMinutes(r);
        const lateTxt = (lateMin === null || lateMin === undefined) ? "-" : String(lateMin);

        const approvedBy = getApprovedBy(r) || "-";

        return [
          String(idx+1),
          String(roll||""),
          String(nm||""),
          String(year||""),
          String(hostel||""),
          String(room||""),
          String(outDT||""),
          String(inDT||""),
          String(lt||""),
          String(approvedBy),
          String(verified),
          String(actualIn),
          String(lateTxt),
          String(phone||""),
          String(reason||"")
        ];
      });

      docp.autoTable({
        startY: y,
        theme: "grid",
        styles: { font: "helvetica", fontSize: 9, cellPadding: 4 },
        headStyles: { fillColor: [193,18,31], textColor: [255,255,255], fontStyle: "bold" },
        alternateRowStyles: { fillColor: [250,250,250] },
        head: [[
          "S.No","Roll No","Student Name","Year","Hostel","Room",
          "Out Date & Time","In Date & Time","Leave Type",
          "Approved By",
          "Arrival Verified","Actual In Time","Late (min)",
          "Contact","Reason"
        ]],
        body
      });

      const safe = (s) => String(s||"").replace(/[^\w\-]+/g, "_");
      const filename = `XIME_${safe(meta.fileTag)}_${safe(meta.from)}_to_${safe(meta.to)}.pdf`;
      docp.save(filename);
    }

    repDownloadBtn.addEventListener("click", async () => {
      try{
        showToast("", "");
        repDownloadBtn.disabled = true;

        const rows = await fetchRowsForReport();
        if (!rows.length){
          showToast("bad", "No records found for the selected filters.");
          return;
        }

        const from = repFrom.value || "—";
        const to = repTo.value || "—";
        const year = repYear.value || "";
        const roll = normalizeRollno(repRoll.value || "");

        const modeLabel =
          reportMode === "student"
            ? "Student-wise (Roll No + Timeframe)"
            : (reportMode === "late"
                ? "Latecomers (Verified + Late)"
                : "Timeframe (Approved Final + Dean Approved)");

        const title =
          reportMode === "late"
            ? "Leave Management System — Latecomers Report"
            : "Leave Management System — Approved Report";

        makePDF(rows, {
          from, to, roll,
          mode: reportMode,
          modeLabel,
          yearLabel: year ? `Year ${year}` : "All Years",
          title,
          fileTag: reportMode === "late" ? "Latecomers" : (reportMode === "student" ? `Approved_${roll}` : "Approved")
        });

        showToast("good", `Downloaded PDF with ${rows.length} records.`);
      }catch(e){
        console.error(e);
        showToast("bad", e?.message || "Unable to download report.");
      }finally{
        repDownloadBtn.disabled = false;
      }
    });

    /* ---------------- Auth ---------------- */
    onAuthStateChanged(auth, async (u) => {
      if (!u){
        window.location.replace("../index.html");
        return;
      }

      if (normalizeEmail(u.email) !== normalizeEmail(DEAN_EMAIL)){
        alert("Access denied. Dean only.");
        try{ await signOut(auth); }catch(_){}
        window.location.replace("../index.html");
        return;
      }

      setMode("timeframe");
      showPage("dash");
      await loadDashboard();
    });
  </script>
</body>
</html>
