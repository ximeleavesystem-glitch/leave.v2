<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>XIME — Student Dashboard</title>

  <style>
    :root{
      --red:#c1121f;
      --redDark:#9b0f19;

      --bg:#fbfbfc;
      --card:#ffffff;
      --ink:#111827;
      --muted:#6b7280;

      --line:#e5e7eb;
      --soft:#f6f7f9;

      --good:#0f766e;
      --bad:#b42318;
      --warn:#b54708;

      --shadow: 0 10px 24px rgba(17,24,39,.08);
      --radius: 16px;

      --font: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial;
    }

    *{ box-sizing:border-box; }
    body{
      margin:0;
      font-family:var(--font);
      color:var(--ink);
      background:
        radial-gradient(1000px 520px at 20% 0%, rgba(193,18,31,.06), transparent 55%),
        radial-gradient(900px 500px at 90% 10%, rgba(193,18,31,.05), transparent 55%),
        linear-gradient(180deg, #fff 0%, #fff 45%, var(--bg) 100%);
      min-height:100vh;
    }

    /* ===== Topbar ===== */
    .topbar{
      position:sticky;
      top:0;
      z-index:50;
      background: rgba(255,255,255,.86);
      backdrop-filter: blur(12px);
      border-bottom:1px solid var(--line);
    }
    .topbarInner{
      max-width:1120px;
      margin:0 auto;
      padding:12px 16px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
    }

    .brand{
      display:flex;
      align-items:center;
      gap:12px;
      min-width:0;
    }
    .brand img{
      width:96px;
      max-height:48px;
      height:auto;
      object-fit:contain;
      display:block;
    }
    .brandText{
      display:flex;
      flex-direction:column;
      line-height:1.15;
      min-width:0;
    }
    .brandText .inst{
      font-size:14px;
      font-weight:800;
      color:var(--ink);
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
      max-width:520px;
    }
    .brandText .sys{
      font-size:16px;
      font-weight:800;
      color:var(--red);
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
      max-width:520px;
    }

    .actions{
      display:flex;
      align-items:center;
      gap:10px;
      flex-shrink:0;
    }

    .btn{
      border:none;
      border-radius:12px;
      padding:10px 12px;
      cursor:pointer;
      font-weight:800;
      color:#fff;
      background: linear-gradient(135deg, var(--red), #ff3b3b);
      box-shadow: 0 10px 20px rgba(193,18,31,.14);
      transition: transform .12s ease, box-shadow .12s ease, opacity .12s ease;
      font-size:13px;
      line-height:1;
      user-select:none;
    }
    .btn:hover{ transform: translateY(-1px); }
    .btn:active{ transform: translateY(0px); opacity:.92; }
    .btn:disabled{ opacity:.6; cursor:not-allowed; transform:none; }

    .btn.secondary{
      background:#fff;
      color:var(--ink);
      border:1px solid var(--line);
      box-shadow:none;
    }
    .btn.secondary:hover{ border-color: rgba(193,18,31,.35); }

    /* ===== Layout ===== */
    .wrap{
      max-width:1120px;
      margin:0 auto;
      padding:16px 16px 28px;
    }

    .pageTitleRow{
      display:flex;
      align-items:flex-end;
      justify-content:space-between;
      gap:12px;
      margin-bottom:14px;
    }
    .pageTitle{
      margin:0;
      font-size:18px;
      font-weight:850;
      color:var(--ink);
    }
    .subTitle{
      margin:4px 0 0;
      font-size:12.5px;
      color:var(--muted);
      font-weight:650;
    }

    /* ===== Tabs ===== */
    .mainTabs{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      margin:14px 0 14px;
    }
    .mainTab{
      border:1px solid var(--line);
      background:#fff;
      padding:10px 12px;
      border-radius:999px;
      cursor:pointer;
      font-weight:800;
      font-size:13px;
      color:var(--ink);
      transition:.12s ease;
      min-width: 140px;
      user-select:none;
    }
    .mainTab:hover{ border-color: rgba(193,18,31,.35); transform: translateY(-1px); }
    .mainTab.active{
      border-color: rgba(193,18,31,.55);
      background: rgba(193,18,31,.06);
      color: var(--redDark);
      box-shadow: 0 10px 18px rgba(193,18,31,.08);
    }

    /* ===== Card ===== */
    .card{
      background:var(--card);
      border:1px solid var(--line);
      border-radius:var(--radius);
      box-shadow:var(--shadow);
      overflow:hidden;
    }
    .cardHead{
      padding:14px 16px;
      border-bottom:1px solid var(--line);
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:10px;
      background: linear-gradient(180deg, rgba(193,18,31,.045) 0%, rgba(255,255,255,1) 70%);
    }
    .cardTitle{
      margin:0;
      font-size:15px;
      font-weight:850;
      color:var(--ink);
    }
    .cardBody{ padding:14px 16px 16px; }
    .hidden{ display:none !important; }

    /* ===== Profile ===== */
    .profileRow{
      display:grid;
      grid-template-columns: 200px 1fr;
      gap:14px;
      align-items:start;
    }
    @media (max-width: 820px){
      .profileRow{ grid-template-columns: 1fr; }
      .brandText .inst, .brandText .sys{ max-width: 240px; }
    }

    .photoBox{
      border:1px solid var(--line);
      border-radius:16px;
      background: var(--soft);
      padding:12px;
      display:flex;
      flex-direction:column;
      gap:10px;
      align-items:center;
      justify-content:center;
      min-height:260px;
    }

    .avatar{
      width:170px;
      height:220px;
      border-radius:18px;
      border:1px solid var(--line);
      background:#fff;
      object-fit:cover;
      display:none;
    }

    .avatarPlaceholder{
      width:170px;
      height:220px;
      border-radius:18px;
      border:1px dashed rgba(193,18,31,.35);
      background: rgba(193,18,31,.05);
      display:grid;
      place-items:center;
      color:var(--redDark);
      font-weight:850;
      font-size:14px;
      text-align:center;
      padding:12px;
    }
    .photoHint{
      font-size:11px;
      color:var(--muted);
      font-weight:650;
      text-align:center;
      line-height:1.35;
    }

    .grid2{ display:grid; grid-template-columns:1fr 1fr; gap:10px; }
    @media (max-width: 560px){ .grid2{ grid-template-columns:1fr; } }

    .kv{
      border:1px solid var(--line);
      background: #fff;
      border-radius:14px;
      padding:10px 12px;
    }
    .kv .k{
      font-size:11px;
      color:var(--muted);
      font-weight:750;
      letter-spacing:.2px;
      margin-bottom:4px;
    }
    .kv .v{
      font-size:13.5px;
      font-weight:750;
      color:var(--ink);
      word-break:break-word;
    }

    /* ===== Form ===== */
    .row2{ display:grid; grid-template-columns:1fr 1fr; gap:10px; }
    @media (max-width: 700px){ .row2{ grid-template-columns:1fr; } }

    .field{ display:flex; flex-direction:column; gap:6px; margin-bottom:10px; }
    label{ font-size:12px; color:var(--muted); font-weight:750; }
    input, textarea, select{
      border:1px solid var(--line);
      background:#fff;
      color:var(--ink);
      padding:11px 12px;
      border-radius:14px;
      outline:none;
      font-size:14px;
      transition:.12s ease;
      font-family:var(--font);
    }
    textarea{ min-height:92px; resize:vertical; }
    input:focus, textarea:focus, select:focus{
      border-color: rgba(193,18,31,.55);
      box-shadow: 0 0 0 4px rgba(193,18,31,.10);
    }

    .muted{ color:var(--muted); font-weight:650; }

    /* ===== History list ===== */
    .list{ display:flex; flex-direction:column; gap:10px; }
    .item{
      border:1px solid var(--line);
      border-radius:14px;
      padding:12px;
      background:#fff;
      display:flex;
      flex-direction:column;
      gap:10px;
    }
    .itemTop{
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:12px;
    }
    .left{
      display:flex;
      flex-direction:column;
      gap:6px;
      min-width:0;
    }
    .t{ font-weight:750; font-size:13.5px; color:var(--ink); }
    .m{ font-size:12.5px; color:var(--muted); font-weight:650; line-height:1.35; }

    .rightCol{
      display:flex;
      flex-direction:column;
      gap:8px;
      align-items:flex-end;
      flex-shrink:0;
    }

    .status{
      border-radius:999px;
      padding:6px 10px;
      font-size:12px;
      font-weight:800;
      border:1px solid var(--line);
      background:var(--soft);
      white-space:nowrap;
      height:fit-content;
    }
    .status.pending{ color: var(--warn); border-color: rgba(181,71,8,.25); background: rgba(181,71,8,.06); }
    .status.approved{ color: var(--good); border-color: rgba(15,118,110,.25); background: rgba(15,118,110,.06); }
    .status.rejected{ color: var(--bad); border-color: rgba(180,35,24,.22); background: rgba(180,35,24,.06); }

    /* ===== Toast ===== */
    .toast{
      margin-top:10px;
      border-radius:12px;
      padding:10px 12px;
      border:1px solid var(--line);
      background:#fff;
      display:none;
      font-size:13px;
      line-height:1.45;
      font-weight:650;
    }
    .toast.show{ display:block; }
    .toast.good{ border-color: rgba(15,118,110,.25); background: rgba(15,118,110,.06); color:#0f3d39; }
    .toast.bad{ border-color: rgba(180,35,24,.22); background: rgba(180,35,24,.06); color:#5a1110; }

    /* ===== Stage-wise ===== */
    .stageWrap{
      border:1px dashed rgba(193,18,31,.22);
      background: rgba(193,18,31,.03);
      border-radius:14px;
      padding:10px;
    }
    .stageTitle{
      font-size:12px;
      font-weight:850;
      color:var(--redDark);
      margin-bottom:8px;
    }
    .stages{ display:flex; flex-direction:column; gap:8px; }
    .stageRow{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      padding:8px 10px;
      border-radius:12px;
      background:#fff;
      border:1px solid var(--line);
    }
    .stageLeft{ display:flex; flex-direction:column; gap:2px; min-width:0; }
    .stageName{ font-weight:800; font-size:13px; }
    .stageMeta{ font-size:11px; color:var(--muted); font-weight:650; overflow:hidden; text-overflow:ellipsis; white-space:nowrap; max-width:520px; }
    .stageBadge{
      border-radius:999px;
      padding:6px 10px;
      font-size:11px;
      font-weight:850;
      border:1px solid var(--line);
      background:var(--soft);
      white-space:nowrap;
    }
    .sb-pending{ color:var(--warn); border-color: rgba(181,71,8,.25); background: rgba(181,71,8,.06); }
    .sb-approved{ color:var(--good); border-color: rgba(15,118,110,.25); background: rgba(15,118,110,.06); }
    .sb-rejected{ color:var(--bad); border-color: rgba(180,35,24,.22); background: rgba(180,35,24,.06); }

    .arrivalBox{
      border:1px dashed rgba(15,118,110,.25);
      background: rgba(15,118,110,.04);
      border-radius:14px;
      padding:10px;
      display:flex;
      flex-direction:column;
      gap:8px;
    }
    .arrivalRow{
      display:flex;
      gap:10px;
      align-items:center;
      flex-wrap:wrap;
    }
    .arrivalRow input{ max-width:200px; }
    .tiny{
      font-size:11.5px;
      color:var(--muted);
      font-weight:650;
      line-height:1.35;
    }
  </style>
</head>

<body>
  <div class="topbar">
    <div class="topbarInner">
      <div class="brand">
        <img id="ximeLogo" src="../assets/img/xime-logo.jpg" alt="XIME Logo" />
        <div class="brandText">
          <div class="inst">Xavier Institute of Management and Entrepreneurship</div>
          <div class="sys">Leave Management System</div>
        </div>
      </div>

      <div class="actions">
        <button class="btn secondary" id="logoutBtn" type="button">Logout</button>
      </div>
    </div>
  </div>

  <div class="wrap">
    <div class="pageTitleRow">
      <div>
        <h2 class="pageTitle">Student Dashboard</h2>
        <div class="subTitle"></div>
      </div>
    </div>

    <div class="mainTabs">
      <button class="mainTab active" id="mainProfile" type="button">Profile</button>
      <button class="mainTab" id="mainApply" type="button">Apply Leave</button>
      <button class="mainTab" id="mainHistory" type="button">History</button>
    </div>

    <!-- PROFILE -->
    <section class="card" id="secProfile">
      <div class="cardHead">
        <h3 class="cardTitle">Profile</h3>
        <div class="muted" id="profileMeta">—</div>
      </div>
      <div class="cardBody">
        <div class="profileRow">
          <div class="photoBox">
            <img id="avatar" class="avatar" alt="Student photo" />
            <div id="avatarPh" class="avatarPlaceholder">_toggle_ PHOTO</div>
            <div class="photoHint" id="photoHint">Photo will appear here if available.</div>
          </div>

          <div class="grid2">
            <div class="kv"><div class="k">NAME</div><div class="v" id="p_name">—</div></div>
            <div class="kv"><div class="k">ROLL NO</div><div class="v" id="p_roll">—</div></div>
            <div class="kv"><div class="k">EMAIL</div><div class="v" id="p_email">—</div></div>
            <div class="kv"><div class="k">BATCH</div><div class="v" id="p_batch">—</div></div>
            <div class="kv"><div class="k">YEAR</div><div class="v" id="p_year">—</div></div>
            <div class="kv"><div class="k">HOSTEL</div><div class="v" id="p_hostel">—</div></div>
            <div class="kv"><div class="k">ROOM NO</div><div class="v" id="p_room">Not updated</div></div>
          </div>
        </div>
      </div>
    </section>

    <!-- APPLY -->
    <section class="card hidden" id="secApply">
      <div class="cardHead">
        <h3 class="cardTitle">Apply Leave</h3>
        <div class="muted">Routing is automatic (based on OUT time).</div>
      </div>

      <div class="cardBody">
        <form id="leaveForm">
          <div class="row2">
            <div class="field">
              <label for="outDT">Out Date & Time</label>
              <input id="outDT" type="datetime-local" required />
            </div>
            <div class="field">
              <label for="inDT">In Date & Time</label>
              <input id="inDT" type="datetime-local" required />
            </div>
          </div>

          <div class="field">
            <label for="reasonCategory">Reason Category</label>
            <select id="reasonCategory" required>
              <option value="" selected disabled>Select a reason</option>
              <option value="personal">Personal</option>
              <option value="academic">Academic (SIP/Placement/IV/Competition)</option>
              <option value="emergency">Emergency (Medical/Family)</option>
              <option value="vacation">Vacation</option>
              <option value="other">Other</option>
            </select>
          </div>

          <div class="field">
            <label for="reasonText">Reason Details <span class="muted" id="reasonHint">(optional)</span></label>
            <textarea id="reasonText" placeholder="Type details (mandatory only for Other)"></textarea>
          </div>

          <div class="row2">
            <div class="field">
              <label for="roomNo">Room Number</label>
              <input id="roomNo" type="text" placeholder="Room number" required />
            </div>
            <div class="field">
              <label for="phone">Contact Number</label>
              <input id="phone" type="tel" placeholder="10-digit number" inputmode="numeric" maxlength="10" pattern="\d{10}" required />
            </div>
          </div>

          <button class="btn" id="submitLeaveBtn" type="submit">Submit Request</button>
          <div id="toastLeave" class="toast"></div>
        </form>
      </div>
    </section>

    <!-- HISTORY -->
    <section class="card hidden" id="secHistory">
      <div class="cardHead">
        <h3 class="cardTitle">History</h3>
        <div class="muted" id="historyMeta">—</div>
      </div>

      <div class="cardBody">
        <div class="list" id="historyList"></div>
        <div id="toastHistory" class="toast"></div>
      </div>
    </section>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
    import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js";
    import {
      getFirestore, doc, getDoc, collection, addDoc, updateDoc,
      getDocs, query, where, limit,
      serverTimestamp, Timestamp
    } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";

    // ✅ bfcache fix
    window.addEventListener("pageshow", (e) => {
      if (e.persisted) window.location.reload();
    });

    const firebaseConfig = {
      apiKey: "AIzaSyDgoq2rMU5kiKcz_27-hjBzd8rxS8yQqdY",
      authDomain: "xime-leave-system-b25a4.firebaseapp.com",
      projectId: "xime-leave-system-b25a4",
      storageBucket: "xime-leave-system-b25a4.firebasestorage.app",
      messagingSenderId: "802112635142",
      appId: "1:802112635142:web:0fd0f5ad1ae3ef8eb4de87"
    };

    const DEAN_EMAIL = "deanacademicchennai@xime.org";
    const GATE_OTP_ENDPOINT = "https://xime-gate-otp-engine.vercel.app/api/gateCode";

    const APPROVER_NAMES = {
      "bothichandar@xime.org": "Bothichandar",
      "arulmary@xime.org": "Arulmary",
      "snehaprabha@xime.org": "Sneha Prabha",
      "deanacademicchennai@xime.org": "Dean Academic"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    // ✅ logo fallback (GitHub pages safe)
    const logo = document.getElementById("ximeLogo");
    logo.addEventListener("error", () => {
      if (!logo.dataset.try2){
        logo.dataset.try2 = "1";
        logo.src = "../assets/img/xime-logo.jpg";
        return;
      }
      logo.style.display = "none";
    });

    // ===== DOM =====
    const logoutBtn = document.getElementById("logoutBtn");

    const mainProfile = document.getElementById("mainProfile");
    const mainApply = document.getElementById("mainApply");
    const mainHistory = document.getElementById("mainHistory");

    const secProfile = document.getElementById("secProfile");
    const secApply = document.getElementById("secApply");
    const secHistory = document.getElementById("secHistory");

    const profileMeta = document.getElementById("profileMeta");
    const historyMeta = document.getElementById("historyMeta");

    const p_name = document.getElementById("p_name");
    const p_roll = document.getElementById("p_roll");
    const p_email = document.getElementById("p_email");
    const p_batch = document.getElementById("p_batch");
    const p_year = document.getElementById("p_year");
    const p_hostel = document.getElementById("p_hostel");
    const p_room = document.getElementById("p_room");

    const avatar = document.getElementById("avatar");
    const avatarPh = document.getElementById("avatarPh");
    const photoHint = document.getElementById("photoHint");

    const outDT = document.getElementById("outDT");
    const inDT = document.getElementById("inDT");

    const reasonCategory = document.getElementById("reasonCategory");
    const reasonText = document.getElementById("reasonText");
    const reasonHint = document.getElementById("reasonHint");

    const roomNo = document.getElementById("roomNo");
    const phone = document.getElementById("phone");

    const leaveForm = document.getElementById("leaveForm");
    const submitLeaveBtn = document.getElementById("submitLeaveBtn");
    const toastLeave = document.getElementById("toastLeave");

    const historyList = document.getElementById("historyList");
    const toastHistory = document.getElementById("toastHistory");

    // ===== Helpers =====
    function showToast(el, msg, type="good"){
      el.className = "toast show " + (type === "bad" ? "bad" : "good");
      el.textContent = msg;
    }
    function clearToast(el){ el.className = "toast"; el.textContent = ""; }

    function normalizeRoll(v){ return String(v || "").trim().toUpperCase(); }
    function normalizeEmail(v){ return String(v || "").trim().toLowerCase(); }

    function toJSDate(x){
      if (!x) return null;
      if (x instanceof Date) return x;
      if (typeof x?.toDate === "function") return x.toDate();
      if (typeof x?.toMillis === "function") return new Date(x.toMillis());
      const d = new Date(x);
      return isNaN(d) ? null : d;
    }

    function fmtDT(d){
      const dt = toJSDate(d);
      if (!dt) return "-";
      const dd = String(dt.getDate()).padStart(2, "0");
      const mm = String(dt.getMonth() + 1).padStart(2, "0");
      const yyyy = dt.getFullYear();
      let hh = dt.getHours();
      const min = String(dt.getMinutes()).padStart(2, "0");
      const ampm = hh >= 12 ? "PM" : "AM";
      hh = hh % 12; hh = hh ? hh : 12;
      hh = String(hh).padStart(2, "0");
      return `${dd}/${mm}/${yyyy}  ${hh}:${min} ${ampm}`;
    }

    function minutesToHM(mins){
      const m = Math.max(0, Math.floor(Number(mins) || 0));
      const h = Math.floor(m / 60);
      const r = m % 60;
      if (h <= 0) return `${r}m`;
      if (r === 0) return `${h}h`;
      return `${h}h ${r}m`;
    }

    function displayNameForEmail(email){
      const e = normalizeEmail(email);
      return APPROVER_NAMES[e] || e || "—";
    }

    function roleLabel(role){
      const r = String(role || "").toLowerCase();
      if (r === "batch_coordinator") return "Batch Coordinator";
      if (r === "warden") return "Warden";
      if (r === "dean") return "Dean";
      return "Approver";
    }

    function statusBadgeClass(status){
      const s = String(status || "").toLowerCase();
      if (s.startsWith("pending")) return "pending";
      if (s.startsWith("rejected")) return "rejected";
      if (s.startsWith("approved")) return "approved";
      return "pending";
    }

    function statusLabel(status){
      const s = String(status || "").toLowerCase();
      if (s === "pending_l1") return "PENDING (L1)";
      if (s === "pending_dean") return "PENDING (DEAN)";
      if (s === "rejected_l1") return "REJECTED (L1)";
      if (s === "rejected_dean") return "REJECTED (DEAN)";
      if (s === "approved_final") return "APPROVED";
      if (s === "approved_dean_final") return "APPROVED";
      return (status || "PENDING").toString().toUpperCase();
    }

    // ✅ weekend counter policy (Fri/Sat only)
    function computeOutDayGroup(outDate){
      const dow = outDate.getDay(); // 0 Sun .. 6 Sat
      if (dow === 5 || dow === 6) return "weekend_block";
      return "weekday";
    }

    function computeL1Role(outDate){
      const dow = outDate.getDay();
      const mins = outDate.getHours() * 60 + outDate.getMinutes();

      if (dow === 5 || dow === 6) return "batch_coordinator";

      if (dow === 0){
        return (mins <= 18*60) ? "batch_coordinator" : "warden";
      }

      const dayStart = 8*60;
      const dayEnd = 18*60;
      if (mins >= dayStart && mins <= dayEnd) return "batch_coordinator";
      return "warden";
    }

    function computeOutWindow(outDate){
      const mins = outDate.getHours() * 60 + outDate.getMinutes();
      const dayStart = 8*60;
      const dayEnd = 18*60;
      return (mins >= dayStart && mins <= dayEnd) ? "day" : "night";
    }

    // ✅ secure routing config read (NO LIST/QUERY)
    async function getRoutingEmail(docId, fallbackEmail=""){
      try{
        const snap = await getDoc(doc(db, "routing_config", docId));
        if (!snap.exists()) return normalizeEmail(fallbackEmail);
        const data = snap.data() || {};
        const active = data.is_active !== false;
        const email = normalizeEmail(data.email || "");
        if (!active || !email) return normalizeEmail(fallbackEmail);
        return email;
      }catch(_){
        return normalizeEmail(fallbackEmail);
      }
    }

    // Hard fallback (only if routing_config not present)
    function fallbackBCEmailByYear(year){
      const y = Number(year) || 0;
      if (y === 2) return "bothichandar@xime.org";
      if (y === 1) return "arulmary@xime.org";
      return "arulmary@xime.org";
    }
    function fallbackWardenByHostel(hostel){
      const h = String(hostel || "").toLowerCase();
      if (h === "boys") return "bothichandar@xime.org";
      if (h === "girls") return "snehaprabha@xime.org";
      if (h === "guest_house") return "arulmary@xime.org";
      return "";
    }

    function setMainTab(which){
      [mainProfile, mainApply, mainHistory].forEach(x => x.classList.remove("active"));
      [secProfile, secApply, secHistory].forEach(x => x.classList.add("hidden"));
      if (which === "profile"){ mainProfile.classList.add("active"); secProfile.classList.remove("hidden"); }
      if (which === "apply"){ mainApply.classList.add("active"); secApply.classList.remove("hidden"); }
      if (which === "history"){ mainHistory.classList.add("active"); secHistory.classList.remove("hidden"); }
    }

    mainProfile.addEventListener("click", () => setMainTab("profile"));
    mainApply.addEventListener("click", () => setMainTab("apply"));
    mainHistory.addEventListener("click", async () => {
      setMainTab("history");
      if (studentEmailLower){
        await loadHistoryByEmail(studentEmailLower);
      }
    });

    logoutBtn.addEventListener("click", async () => {
      try{ await signOut(auth); }catch(_){}
      window.location.replace("../index.html");
    });

    phone.addEventListener("input", () => {
      phone.value = phone.value.replace(/\D/g, "").slice(0, 10);
    });

    reasonCategory.addEventListener("change", () => {
      const v = String(reasonCategory.value || "");
      reasonHint.textContent = (v === "other") ? "(mandatory)" : "(optional)";
    });

    // ===== Photo handling =====
    function extractDriveId(url){
      const u = String(url || "").trim();
      if (!u) return "";
      const m1 = u.match(/drive\.google\.com\/file\/d\/([^\/]+)\//);
      if (m1 && m1[1]) return m1[1];
      const m2 = u.match(/[?&]id=([^&]+)/);
      if (m2 && m2[1]) return m2[1];
      const m3 = u.match(/uc\?export=view&id=([^&]+)/);
      if (m3 && m3[1]) return m3[1];
      return "";
    }

    function resolveDriveUrls(rawLink){
      const id = extractDriveId(rawLink);
      if (!id) return { primary: rawLink, fallback: "" };
      return {
        primary: `https://lh3.googleusercontent.com/d/${id}=w1000`,
        fallback: `https://drive.google.com/uc?export=view&id=${id}`
      };
    }

    function resolvePhotoURL(studentObj){
      const raw =
        studentObj?.student_photo_url ||
        studentObj?.studentPhotoUrl ||
        studentObj?.photo_url ||
        studentObj?.photoUrl ||
        studentObj?.photoURL ||
        studentObj?.photo ||
        studentObj?.photoLink ||
        studentObj?.imageUrl ||
        studentObj?.imageURL ||
        "";

      const link = String(raw || "").trim();
      if (!link) return { primary: "", fallback: "" };

      if (link.includes("drive.google.com") || link.includes("googleusercontent.com")) return resolveDriveUrls(link);
      if (link.startsWith("http://") || link.startsWith("https://")) return { primary: link, fallback: "" };
      return { primary: "", fallback: "" };
    }

    function setStudentPhoto(studentObj){
      const { primary, fallback } = resolvePhotoURL(studentObj);

      avatar.style.display = "none";
      avatarPh.style.display = "grid";

      if (!primary){
        photoHint.textContent = "Photo will appear here if available.";
        return;
      }

      photoHint.textContent = "Loading photo…";
      let usedFallback = false;

      avatar.referrerPolicy = "no-referrer";

      avatar.onload = () => {
        avatar.style.display = "block";
        avatarPh.style.display = "none";
        photoHint.textContent = "";
      };

      avatar.onerror = () => {
        if (!usedFallback && fallback){
          usedFallback = true;
          avatar.src = fallback;
          return;
        }
        avatar.style.display = "none";
        avatarPh.style.display = "grid";
        photoHint.textContent = "Photo could not be displayed.";
      };

      avatar.src = primary;
    }

    // ===== Data =====
    let currentUser = null;
    let student = null;
    let studentRoll = null;
    let studentEmailLower = "";

    async function getUserMapping(uid){
      const snap = await getDoc(doc(db, "users", uid));
      if (!snap.exists()) throw new Error("User mapping not found. Contact Batch Coordinator.");
      return snap.data();
    }

    async function getRoster(roll){
      const snap = await getDoc(doc(db, "students_roster", roll));
      if (!snap.exists()) throw new Error("Roster not found. Contact Batch Coordinator.");
      return snap.data();
    }

    function getCreatedMillis(r){
      const c = r.created_at || r.createdAt || r.updated_at || r.updatedAt;
      if (!c) return 0;
      if (typeof c.toMillis === "function") return c.toMillis();
      if (typeof c.toDate === "function") return c.toDate().getTime();
      const d = new Date(c);
      return isNaN(d) ? 0 : d.getTime();
    }

    function renderStages(chain){
      const arr = Array.isArray(chain) ? chain : [];
      if (!arr.length) return "";

      const rows = arr.map(x => {
        const email = normalizeEmail(x.email || "");
        const role = roleLabel(x.role || "");
        const act = String(x.action || "pending").toLowerCase();
        const actedAt = x.acted_at || x.actedAt || null;
        const remark = x.remark || "";

        const badgeClass =
          act === "approved" ? "stageBadge sb-approved" :
          act === "rejected" ? "stageBadge sb-rejected" :
          "stageBadge sb-pending";

        const badgeText =
          act === "approved" ? "APPROVED" :
          act === "rejected" ? "REJECTED" :
          "PENDING";

        const metaParts = [
          role,
          email ? `• ${email}` : "",
          actedAt ? `• ${fmtDT(actedAt)}` : "",
          remark ? `• ${remark}` : ""
        ].filter(Boolean);

        return `
          <div class="stageRow">
            <div class="stageLeft">
              <div class="stageName">${displayNameForEmail(email)}</div>
              <div class="stageMeta">${metaParts.join(" ")}</div>
            </div>
            <div class="${badgeClass}">${badgeText}</div>
          </div>
        `;
      }).join("");

      return `
        <div class="stageWrap">
          <div class="stageTitle">Approval Status (Stage-wise)</div>
          <div class="stages">${rows}</div>
        </div>
      `;
    }

    function isApprovedStatus(status){
      const s = String(status || "").toLowerCase();
      return s === "approved_final" || s === "approved_dean_final";
    }

    async function verifyArrival(requestId, row, codeInputEl, toastEl){
      clearToast(toastEl);

      try{
        const outTs = row.out_datetime;
        const inTs = row.in_datetime;
        const outDate = toJSDate(outTs);
        const inDate = toJSDate(inTs);
        const now = new Date();

        if (!outDate){
          showToast(toastEl, "Out time missing. Contact admin.", "bad");
          return;
        }

        if (now < outDate){
          await updateDoc(doc(db, "leave_requests", requestId), {
            "arrival.code_last_status": "too_early",
            "arrival.attempted_at": serverTimestamp(),
            updated_at: serverTimestamp()
          });
          showToast(toastEl, "Not yet out — you can verify only after OUT time.", "bad");
          return;
        }

        const entered = String(codeInputEl.value || "").trim();
        if (!entered){
          showToast(toastEl, "Enter the gate code.", "bad");
          return;
        }

        const resp = await fetch(GATE_OTP_ENDPOINT, { cache: "no-store" });
        if (!resp.ok) throw new Error("Gate code server not reachable. Try again.");
        const data = await resp.json();
        const serverCode = String(data?.code || "").trim();

        if (!serverCode || entered !== serverCode){
          await updateDoc(doc(db, "leave_requests", requestId), {
            "arrival.code_last_status": "invalid_code",
            "arrival.attempted_at": serverTimestamp(),
            updated_at: serverTimestamp()
          });
          showToast(toastEl, "Invalid code.", "bad");
          return;
        }

        const actual = now;
        let lateMinutes = 0;
        if (inDate && actual > inDate){
          lateMinutes = Math.floor((actual.getTime() - inDate.getTime()) / (60*1000));
        }

        await updateDoc(doc(db, "leave_requests", requestId), {
          "arrival.verified": true,
          "arrival.code_last_status": "verified",
          "arrival.attempted_at": serverTimestamp(),
          "arrival.verified_at": serverTimestamp(),
          "arrival.actual_in_time": serverTimestamp(),
          "arrival.late_minutes": lateMinutes,
          updated_at: serverTimestamp()
        });

        showToast(toastEl, "Arrival verified successfully.", "good");
        await loadHistoryByEmail(studentEmailLower);

      }catch(err){
        console.error("verifyArrival error:", err);
        showToast(toastEl, err?.message || "Failed to verify arrival.", "bad");
      }
    }

    async function loadHistoryByEmail(studentEmail){
      clearToast(toastHistory);
      historyList.innerHTML = "";
      historyMeta.textContent = "Loading…";

      try{
        const qMine = query(
          collection(db, "leave_requests"),
          where("student_email", "==", studentEmail),
          limit(250)
        );

        const snap = await getDocs(qMine);
        let rows = snap.docs.map(d => ({ id: d.id, ...d.data() }));
        rows.sort((a,b) => getCreatedMillis(b) - getCreatedMillis(a));

        if (!rows.length){
          historyList.innerHTML = `
            <div class="item">
              <div class="left">
                <div class="t">No requests</div>
                <div class="m">No leave history available.</div>
              </div>
            </div>`;
          historyMeta.textContent = "0 requests";
          return;
        }

        const frag = document.createDocumentFragment();

        for (const r of rows){
          const status = String(r.status || "pending_l1");
          const badge = statusBadgeClass(status);

          const outVal = r.out_datetime;
          const inVal = r.in_datetime;

          const holderRole = r.current?.holder_role || "";
          const holderEmail = r.current?.holder_email || r.routing?.l1_email || "";
          const holderText = holderRole
            ? `${roleLabel(holderRole)} (${displayNameForEmail(holderEmail)})`
            : (holderEmail ? displayNameForEmail(holderEmail) : "—");

          const approved = isApprovedStatus(status);

          const arrival = r.arrival || {};
          const arrivalVerified = !!arrival.verified;
          const lateMins = arrival.late_minutes;
          const verifiedAt = arrival.verified_at || arrival.actual_in_time;

          const el = document.createElement("div");
          el.className = "item";

          const showGateBtn = approved && !!r.id;

          let arrivalHTML = "";
          if (approved){
            if (arrivalVerified){
              const msgLate = (Number(lateMins) > 0)
                ? `Late by ${minutesToHM(lateMins)}`
                : `On time`;
              arrivalHTML = `
                <div class="arrivalBox">
                  <div class="t">Arrival: ✅ Verified</div>
                  <div class="m">Verified at: ${fmtDT(verifiedAt)} • ${msgLate}</div>
                </div>
              `;
            }else{
              arrivalHTML = `
                <div class="arrivalBox">
                  <div class="t">Arrival Verification</div>
                  <div class="tiny">Enter the gate code after your OUT time is crossed. This will record your actual in-time.</div>
                  <div class="arrivalRow">
                    <input type="text" inputmode="numeric" placeholder="Enter gate code" maxlength="12" class="gateCodeInput" />
                    <button class="btn secondary verifyBtn" type="button">Verify</button>
                  </div>
                  <div class="toast" style="margin-top:6px;"></div>
                </div>
              `;
            }
          }

          el.innerHTML = `
            <div class="itemTop">
              <div class="left">
                <div class="t">Out: ${fmtDT(outVal)}</div>
                <div class="t">In: ${fmtDT(inVal)}</div>
                <div class="m">Reason: ${String(r.reason_category || "").toUpperCase()}${r.reason_text ? ` • ${r.reason_text}` : ""}</div>
                <div class="m">Current: ${holderText}</div>
              </div>

              <div class="rightCol">
                <div class="status ${badge}">${statusLabel(status)}</div>
                ${ showGateBtn ? `<button class="btn secondary gateBtn" type="button" data-gpid="${r.id}">Gatepass</button>` : `` }
              </div>
            </div>

            ${arrivalHTML}
            ${renderStages(r.approver_chain)}
          `;

          const gateBtn = el.querySelector(".gateBtn");
          if (gateBtn){
            gateBtn.addEventListener("click", () => {
              window.location.href = `./gatepass.html?id=${encodeURIComponent(gateBtn.dataset.gpid)}`;
            });
          }

          const verifyBtn = el.querySelector(".verifyBtn");
          if (verifyBtn){
            const codeInputEl = el.querySelector(".gateCodeInput");
            const toastEl = el.querySelector(".arrivalBox .toast");
            verifyBtn.addEventListener("click", () => verifyArrival(r.id, r, codeInputEl, toastEl));
          }

          frag.appendChild(el);
        }

        historyList.appendChild(frag);
        historyMeta.textContent = `${rows.length} request(s)`;

      }catch(err){
        console.error("History error:", err);
        historyMeta.textContent = "—";
        showToast(toastHistory, "Unable to load history.", "bad");
      }
    }

    async function hasActiveRequestInSameGroup(studentEmail, outDayGroup){
      const q1 = query(
        collection(db, "leave_requests"),
        where("student_email", "==", studentEmail),
        where("routing.out_day_group", "==", outDayGroup),
        limit(250)
      );

      const snap = await getDocs(q1);
      if (snap.empty) return false;

      for (const d of snap.docs){
        const r = d.data() || {};
        const st = String(r.status || "").toLowerCase();

        const isPending = st.startsWith("pending");
        const isApproved = st.startsWith("approved");

        if (!isPending && !isApproved) continue;

        if (isPending) return true;

        if (isApproved){
          const verified = !!(r.arrival && r.arrival.verified);
          if (!verified) return true;
        }
      }

      return false;
    }

    // ===== Submit leave (NEW SCHEMA) =====
    leaveForm.addEventListener("submit", async (e) => {
      e.preventDefault();
      clearToast(toastLeave);

      if (!student || !studentRoll || !studentEmailLower){
        showToast(toastLeave, "Profile not loaded. Please logout and login again.", "bad");
        return;
      }

      if (!auth.currentUser?.uid){
        showToast(toastLeave, "Auth not ready. Please refresh and try again.", "bad");
        return;
      }

      const outISO = outDT.value;
      const inISO  = inDT.value;
      const outDate = new Date(outISO);
      const inDate  = new Date(inISO);

      if (isNaN(outDate) || isNaN(inDate) || inDate <= outDate){
        showToast(toastLeave, "Invalid Out / In date and time.", "bad");
        return;
      }

      const cat = String(reasonCategory.value || "").trim();
      if (!cat){
        showToast(toastLeave, "Please select a reason category.", "bad");
        return;
      }

      const reasonVal = String(reasonText.value || "").trim();
      if (cat === "other" && !reasonVal){
        showToast(toastLeave, "Reason details are mandatory for Other.", "bad");
        return;
      }

      const roomVal  = roomNo.value.trim();
      const phoneVal = phone.value.trim();

      if (!roomVal || !phoneVal){
        showToast(toastLeave, "Please fill all required fields.", "bad");
        return;
      }
      if (!/^\d{10}$/.test(phoneVal)){
        showToast(toastLeave, "Contact number must be exactly 10 digits.", "bad");
        return;
      }

      submitLeaveBtn.disabled = true;

      try{
        const year   = student.year ?? student.year_no ?? student.yearNo ?? "";
        const hostel = String(student.hostel ?? "").toLowerCase(); // boys/girls/guest_house

        const out_day_group = computeOutDayGroup(outDate);
        const out_window    = computeOutWindow(outDate);
        const l1_role        = computeL1Role(outDate);

        // ✅ block multiple active requests in same group
        const hasActiveSameGroup = await hasActiveRequestInSameGroup(studentEmailLower, out_day_group);
        if (hasActiveSameGroup){
          const msg = (out_day_group === "weekend_block")
            ? "You already have an active WEEKEND request. Submit a new weekend request only after your return is verified."
            : "You already have an active WEEKDAY request. Submit a new weekday request only after your return is verified.";
          showToast(toastLeave, msg, "bad");
          return;
        }

        // ✅ Secure routing config fetch (NO LIST)
        let l1_email = "";
        if (l1_role === "batch_coordinator"){
          const y = Number(year) || 0;
          l1_email = await getRoutingEmail(`bc_year_${y}`, fallbackBCEmailByYear(y));
        }else{
          const h = String(hostel || "").toLowerCase(); // boys/girls/guest_house
          l1_email = await getRoutingEmail(`warden_${h}`, fallbackWardenByHostel(h));
        }

        l1_email = normalizeEmail(l1_email);
        if (!l1_email) throw new Error("Approver mapping missing (L1). Contact admin.");

        const payload = {
          student_uid: auth.currentUser.uid,
          student_rollno: studentRoll,
          student_name: student.name || "",
          student_email: studentEmailLower,
          student_year: Number(year) || year,
          student_hostel: hostel,
          student_room_no: roomVal,
          student_photo_url: student.student_photo_url || student.photo_url || "",
          student_email_raw: (auth.currentUser?.email || "").trim(),

          reason_category: cat,
          reason_text: reasonVal,
          out_datetime: Timestamp.fromDate(outDate),
          in_datetime: Timestamp.fromDate(inDate),
          contact_no: phoneVal,

          routing: {
            out_day_group,
            out_window,
            l1_role,
            l1_email,
            dean_email: DEAN_EMAIL,
            policy_version: 2
          },

          status: "pending_l1",
          current: {
            stage: "L1",
            holder_role: l1_role,
            holder_email: l1_email
          },

          current_holder_email: l1_email,
          approver_emails: [l1_email],

          escalation: {
            requested: false,
            requested_by: "",
            requested_at: null,
            reason: "",
            dean_action: "not_required"
          },

          approver_chain: [
            {
              stage: 1,
              role: l1_role,
              email: l1_email,
              action: "pending",
              acted_at: null,
              remark: ""
            }
          ],

          arrival: {
            verified: false,
            attempted_at: null,
            verified_at: null,
            actual_in_time: null,
            code_last_status: "",
            late_minutes: null
          },

          created_at: serverTimestamp(),
          updated_at: serverTimestamp()
        };

        console.log("AUTH UID:", auth.currentUser?.uid);
        console.log("AUTH EMAIL:", auth.currentUser?.email);
        console.log("PAYLOAD UID:", payload.student_uid);
        console.log("PAYLOAD EMAIL:", payload.student_email);
        console.log("PAYLOAD STATUS:", payload.status);

        await addDoc(collection(db, "leave_requests"), payload);

        showToast(toastLeave, "Leave request submitted successfully.", "good");
        leaveForm.reset();
        reasonHint.textContent = "(optional)";

      }catch(err){
        console.error(err);
        showToast(toastLeave, err?.message || "Failed to submit request.", "bad");
      }finally{
        submitLeaveBtn.disabled = false;
      }
    });

    // ===== Auth boot =====
    onAuthStateChanged(auth, async (u) => {
      if (!u){
        window.location.href = "../index.html";
        return;
      }

      currentUser = u;
      studentEmailLower = normalizeEmail(u.email || "");

      try{
        const map = await getUserMapping(u.uid);
        studentRoll = normalizeRoll(map.rollno);
        if (!studentRoll) throw new Error("Roll number not linked. Contact Batch Coordinator.");

        student = await getRoster(studentRoll);
        setStudentPhoto(student);

        p_name.textContent = student.name || "—";
        p_roll.textContent = studentRoll;
        p_email.textContent = u.email || "—";
        p_batch.textContent = (student.batch_no ?? student.batch ?? student.batchNo ?? "—");
        p_year.textContent = (student.year ?? student.yearNo ?? student.year_no ?? "—");
        p_hostel.textContent = (student.hostel ?? "—");

        const room = String(student.room_no ?? student.roomNo ?? student.room ?? "").trim();
        p_room.textContent = room ? room : "Not updated";
        if (room) roomNo.value = room;

        profileMeta.textContent = `Logged in as ${studentRoll}`;
        historyMeta.textContent = "Open History to load requests";

        setMainTab("profile");

      }catch(err){
        setMainTab("profile");
        alert(err?.message || "Failed to load student profile.");
      }
    });
  </script>
</body>
</html>
